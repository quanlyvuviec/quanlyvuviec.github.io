<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Quản Lý Vụ Việc</title>
  <link rel="icon" href="data:;base64,iVBORw0KGgo=">
  <!-- Tailwind CSS (local) -->
  <link rel="stylesheet" href="./libs/tailwind.min.css">
  <!-- Flatpickr CSS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <!-- Các script JS (local, defer để load async) -->
  <script src="./libs/react.min.js" defer></script>
  <script src="./libs/react-dom.min.js" defer></script>
  <script src="./libs/babel.min.js" defer data-warnings="none"></script> <!-- Tắt warning Babel -->
  <script src="./libs/docx.min.js" defer></script>
  <script src="./libs/FileSaver.min.js" defer></script>
  <script src="./libs/xlsx.full.min.js" defer></script>
  <!-- Flatpickr JS -->
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <style>
    .fixed-width-name { width: 200px; min-width: 200px; }
    .fixed-width-birth { width: 120px; min-width: 120px; }
    .fixed-width-address { width: 250px; min-width: 250px; }
    .fixed-width-status { width: 150px; min-width: 150px; }
    textarea[name="familyBackground"], textarea[name="description"], textarea[name="seizedItems"] {
      min-width: 300px;
      min-height: 120px;
      resize: vertical;
      overflow: auto;
    }
    .fixed-width-stt { width: 30px; min-width: 30px; }
    .fixed-width-id { width: 50px; min-width: 50px; }
    .fixed-width-type { width: 200px; min-width: 200px; }
    .fixed-width-date { width: 90px; min-width: 90px; }
    .fixed-width-description { width: 350px; min-width: 350px; }
    .fixed-width-object-count { width: 40px; min-width: 40px; }
    .fixed-width-action { width: 100px; min-width: 100px; }
    .fixed-width-investigation-result { width: 100px; min-width: 100px; }
    .wrap-text {
      white-space: normal;
      overflow-wrap: break-word;
      overflow: hidden;
    }
    .table-container {
      overflow-x: auto;
    }
    .table-fixed {
      table-layout: fixed;
      width: 100%;
    }
    .undo-toast, .error-toast {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background-color: #ef4444;
      color: white;
      padding: 10px 20px;
      border-radius: 5px;
      display: flex;
      align-items: center;
      gap: 10px;
      z-index: 1000;
      font-size: 1.2em;
      font-weight: bold;
      box-shadow: 0 0 10px rgba(0,0,0,0.5);
      animation: blink 1s infinite;
    }
    @keyframes blink {
      50% { opacity: 0.5; }
    }
    .undo-toast button.close, .error-toast button.close {
      background: transparent;
      border: none;
      color: white;
      cursor: pointer;
      font-size: 16px;
    }
    @media (max-width: 768px) {
      .grid-cols-2 {
        grid-template-columns: 1fr;
      }
      textarea[name="familyBackground"], textarea[name="description"], textarea[name="seizedItems"] {
        min-width: 100%;
      }
      .table-fixed {
        min-width: 1200px;
      }
      .table-container {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
      }
    }
    .success-toast {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background-color: #10b981;
      color: white;
      padding: 10px 20px;
      border-radius: 5px;
      display: flex;
      align-items: center;
      gap: 10px;
      z-index: 1000;
    }
    .undo-button {
      background-color: #6b7280;
      color: white;
      px-2 py-1 rounded ml-2 text-sm;
    }
    .photo-container {
      width: 113px; /* khoảng 3cm ở 96dpi */
      height: 151px; /* khoảng 4cm ở 96dpi */
      border: 1px solid #ccc;
      overflow: hidden;
      margin-bottom: 10px;
    }
    .photo-container img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    .action-button {
      width: 100px; /* Đặt chiều rộng cố định cho nút */
      text-align: center;
    }
    .login-background {
     background-image: url('./images/background.jpg');
      background-size: cover;
      background-position: center;
      height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .login-form {
      background-color: rgba(255, 255, 255, 0.9);
      padding: 2rem;
      border-radius: 8px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
      width: 100%;
      max-width: 400px;
    }
    .error-shake {
      animation: shake 0.5s;
    }
    @keyframes shake {
      0% { transform: translateX(0); }
      25% { transform: translateX(-10px); }
      50% { transform: translateX(10px); }
      75% { transform: translateX(-10px); }
      100% { transform: translateX(0); }
    }
    input[type="text"][pattern="\d{2}/\d{2}/\d{4}"] {
      position: relative;
    }
    .fixed-inset-0 {
      z-index: 1000 !important;
    }
  </style>
</head>
<body>
  <div id="root"></div>
  <script type="text/javascript">
    // IndexedDB utilities
    const DB_NAME = 'CaseManagementDB';
    const DB_VERSION = 4;
    const CASES_STORE = 'cases';
    const USERS_STORE = 'users';
    const LISTS_STORE = 'lists';
    let db;
    async function openDB() {
      return new Promise((resolve, reject) => {
        console.log('Opening IndexedDB:', DB_NAME, 'version:', DB_VERSION);
        const request = indexedDB.open(DB_NAME, DB_VERSION);
        request.onupgradeneeded = (event) => {
          console.log('Upgrading IndexedDB schema');
          const db = event.target.result;
          if (!db.objectStoreNames.contains(CASES_STORE)) {
            const casesStore = db.createObjectStore(CASES_STORE, { keyPath: 'id' });
            casesStore.createIndex('dateReceived', 'dateReceived');
            casesStore.createIndex('status', 'status');
            console.log('Created object store:', CASES_STORE);
          }
          if (!db.objectStoreNames.contains(USERS_STORE)) {
            db.createObjectStore(USERS_STORE, { keyPath: 'username' });
            console.log('Created object store:', USERS_STORE);
          }
          if (!db.objectStoreNames.contains(LISTS_STORE)) {
            db.createObjectStore(LISTS_STORE, { keyPath: 'key' });
            console.log('Created object store:', LISTS_STORE);
          }
        };
        request.onsuccess = (event) => {
          console.log('IndexedDB opened successfully');
          db = event.target.result;
          resolve(db);
        };
        request.onerror = (event) => {
          console.error('Error opening IndexedDB:', event.target.error);
          reject(event.target.error);
        };
      });
    }
    async function saveCasesToDB(cases) {
      try {
        const validCases = cases.filter(c => c.id && Array.isArray(c.type) && c.type.length > 0 && c.dateReceived);
        console.log('Valid cases to save:', validCases);
        if (validCases.length === 0) {
          console.warn('No valid cases to save');
          return;
        }
        const db = await openDB();
        console.log('Saving cases to DB:', cases);
        const transaction = db.transaction(CASES_STORE, 'readwrite');
        const store = transaction.objectStore(CASES_STORE);
        cases.forEach(caseItem => {
          console.log('Saving case:', caseItem.id);
          store.put(caseItem);
        });
        return new Promise((resolve, reject) => {
          transaction.oncomplete = () => {
            console.log('Cases saved to DB successfully');
            resolve();
          };
          transaction.onerror = (event) => {
            console.error('Error saving cases to DB:', event.target.error);
            reject(event.target.error);
          };
        });
      } catch (error) {
        console.error('Error in saveCasesToDB:', error);
        throw error;
      }
    }
    async function loadCasesFromDB() {
      const db = await openDB();
      const transaction = db.transaction(CASES_STORE, 'readonly');
      const store = transaction.objectStore(CASES_STORE);
      const request = store.getAll();
      return new Promise((resolve, reject) => {
        request.onsuccess = () => resolve(request.result);
        request.onerror = (event) => reject(event.target.error);
      });
    }
    async function saveUserToDB(user) {
      const db = await openDB();
      const transaction = db.transaction(USERS_STORE, 'readwrite');
      const store = transaction.objectStore(USERS_STORE);
      store.put(user);
      return new Promise((resolve, reject) => {
        transaction.oncomplete = () => resolve();
        transaction.onerror = (event) => reject(event.target.error);
      });
    }
    async function getUserFromDB(username) {
      const db = await openDB();
      const transaction = db.transaction(USERS_STORE, 'readonly');
      const store = transaction.objectStore(USERS_STORE);
      const request = store.get(username);
      return new Promise((resolve, reject) => {
        request.onsuccess = () => resolve(request.result);
        request.onerror = (event) => reject(event.target.error);
      });
    }
    async function saveListsToDB(lists) {
      const db = await openDB();
      const transaction = db.transaction(LISTS_STORE, 'readwrite');
      const store = transaction.objectStore(LISTS_STORE);
      Object.entries(lists).forEach(([key, data]) => {
        store.put({ key, data });
      });
      return new Promise((resolve, reject) => {
        transaction.oncomplete = () => resolve();
        transaction.onerror = (event) => reject(event.target.error);
      });
    }
    async function loadListsFromDB() {
      const db = await openDB();
      const transaction = db.transaction(LISTS_STORE, 'readonly');
      const store = transaction.objectStore(LISTS_STORE);
      const requests = ['caseTypes', 'assignees', 'receivingUnits', 'handlingMethods'].map(key => store.get(key));
      return Promise.all(requests.map(req => new Promise((res, rej) => {
        req.onsuccess = () => res(req.result ? req.result.data : null);
        req.onerror = rej;
      })));
    }
    async function hashPassword(password) {
      const encoder = new TextEncoder();
      const data = encoder.encode(password);
      const hash = await crypto.subtle.digest('SHA-256', data);
      return Array.from(new Uint8Array(hash)).map(b => b.toString(16).padStart(2, '0')).join('');
    }
    async function migrateFromLocalStorage() {
      if (localStorage.getItem('cases')) {
        const savedCases = localStorage.getItem('cases');
        const parsedCases = JSON.parse(savedCases);
        await saveCasesToDB(parsedCases);
        localStorage.removeItem('cases');
      }
    }
    var gk_isXlsx = false;
    var gk_xlsxFileLookup = {};
    var gk_fileData = {};
    function filledCell(cell) {
      return cell !== '' && cell != null;
    }
    function loadFileData(filename, setErrorMessage) {
      if (!gk_isXlsx || !gk_xlsxFileLookup[filename]) {
        setErrorMessage('Không tìm thấy file hoặc định dạng không được hỗ trợ.');
        return "";
      }
      try {
        const workbook = XLSX.read(gk_fileData[filename], { type: 'base64' });
        const firstSheetName = workbook.SheetNames[0];
        const worksheet = workbook.Sheets[firstSheetName];
        const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, blankrows: false, defval: '' });
        const filteredData = jsonData.filter(row => row.some(filledCell));
        let headerRowIndex = filteredData.findIndex((row, index) =>
          filteredData[index + 1] ? row.filter(filledCell).length >= filteredData[index + 1].filter(filledCell).length : false
        );
        if (headerRowIndex === -1 || headerRowIndex > 25) {
          headerRowIndex = 0;
        }
        const csv = XLSX.utils.sheet_to_csv(XLSX.utils.aoa_to_sheet(filteredData.slice(headerRowIndex)));
        return csv;
      } catch (e) {
        console.error('Lỗi khi xử lý file:', e);
        setErrorMessage('Không thể đọc file Excel. Vui lòng kiểm tra định dạng file.');
        return "";
      }
    }
    function validateCases(cases) {
      if (!Array.isArray(cases)) return [];
      const seenIds = new Set();
      return cases.filter(c => {
        if (!c.id || typeof c.id !== 'string' || !Array.isArray(c.type) || c.type.length === 0 || !c.dateReceived) return false;
        if (!/^\d{4}-\d{2}-\d{2}$/.test(c.dateReceived)) return false;
        try {
          const date = new Date(c.dateReceived);
          if (isNaN(date.getTime())) return false;
        } catch {
          return false;
        }
        if (seenIds.has(c.id)) return false;
        seenIds.add(c.id);
        return true;
      });
    }
    function backupCases(cases) {
      try {
        const blob = new Blob([JSON.stringify(cases, null, 2)], { type: 'application/json' });
        saveAs(blob, 'backup_cases.json');
      } catch (error) {
        console.error('Lỗi khi tạo file backup:', error);
        return 'Không thể tạo file sao lưu. Vui lòng kiểm tra kết nối và thử lại.';
      }
      return null;
    }
    function restoreCases(event, setErrorMessage) {
      const file = event.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = async function(e) {
        try {
          if (file.name.endsWith('.xlsx')) {
            gk_isXlsx = true;
            gk_fileData[file.name] = e.target.result.split(',')[1];
            gk_xlsxFileLookup[file.name] = true;
            const csvData = loadFileData(file.name, setErrorMessage);
            if (!csvData) throw new Error('Không thể đọc file Excel.');
            const jsonData = XLSX.utils.sheet_to_json(XLSX.utils.csv_to_sheet(csvData));
            const validatedData = validateCases(jsonData);
            await saveCasesToDB(validatedData);
            window.location.reload();
          } else if (file.name.endsWith('.json')) {
            const data = JSON.parse(e.target.result);
            if (!Array.isArray(data)) throw new Error('Dữ liệu không phải mảng');
            const validatedData = validateCases(data);
            await saveCasesToDB(validatedData);
            window.location.reload();
          } else {
            throw new Error('Định dạng file không được hỗ trợ.');
          }
        } catch (error) {
          console.error('Lỗi khi khôi phục dữ liệu:', error);
          setErrorMessage('Không thể khôi phục dữ liệu từ file. Vui lòng kiểm tra định dạng file (phải là JSON hoặc Excel hợp lệ).');
        }
      };
      reader.readAsDataURL(file);
    }
    function exportToExcel(cases, statusFilter, filterCaseId, filterStartDate, filterEndDate) {
      try {
        let filteredCases = cases;
        if (filterCaseId) {
          filteredCases = filteredCases.filter(c => c.id.toLowerCase().includes(filterCaseId.toLowerCase()));
        }
        if (filterStartDate) {
          filteredCases = filteredCases.filter(c => c.dateReceived >= filterStartDate);
        }
        if (filterEndDate) {
          filteredCases = filteredCases.filter(c => c.dateReceived <= filterEndDate);
        }
        if (statusFilter === 'ongoing') {
          filteredCases = filteredCases.filter(c => c.status !== 'hoàn thành');
        } else if (statusFilter === 'completed') {
          filteredCases = filteredCases.filter(c => c.status === 'hoàn thành');
        }
        const casesData = filteredCases.map((c, index) => {
          const objectsStr = c.objects && c.objects.length > 0
            ? c.objects.map(obj => `${obj.name || ''} - ${obj.relationship || ''}`).join('; ')
            : '';
          return {
            'STT': index + 1,
            'Mã số vụ': c.id || '',
            'Loại vụ việc': Array.isArray(c.type) ? c.type.join(', ') : c.type || '',
            'Ngày tiếp nhận': formatDateToVietnamese(c.dateReceived) || '',
            'Nội dung vụ việc': c.description || '',
            'Đồ vật, tài liệu bị tạm giữ': c.seizedItems || '',
            'Người thụ lý chính': c.assignee || '',
            'Người trực tiếp làm': c.directAssignee || '',
            'Kết quả điều tra': c.investigationResult || '',
            'Loại tội phạm': c.crimeType || '',
            'Số lần gia hạn': c.extensionCount || 0,
            'Ngày kết luận điều tra': formatDateToVietnamese(c.investigationConclusionDate) || '',
            'Ngày khởi tố vụ án': formatDateToVietnamese(c.prosecutionDate) || '',
            'Số QĐ khởi tố vụ án': c.prosecutionDecision || '',
            'Ngày QĐ xử phạt': formatDateToVietnamese(c.penaltyDate) || '',
            'Số QĐ xử phạt': c.penaltyDecision || '',
            'Ngày chuyển': formatDateToVietnamese(c.transferDate) || '',
            'Đơn vị tiếp nhận': c.receivingUnit || '',
            'Trạng thái': c.status || '',
            'Số đối tượng': c.objects ? c.objects.length : 0,
            'Tên đối tượng - Mối quan hệ': objectsStr,
            'Ghi chú': c.notes || ''
          };
        });
        const objectsData = [];
        filteredCases.forEach(c => {
          if (c.objects && c.objects.length > 0) {
            c.objects.forEach(obj => {
              objectsData.push({
                'Mã số vụ': c.id || '',
                'Họ tên': obj.name || '',
                'Giới tính': obj.gender || '',
                'Tên gọi khác': obj.alias || '',
                'Sinh ngày': formatDateToVietnamese(obj.birthDate) || '',
                'Tại': obj.birthPlace || '',
                'Quê quán': obj.hometown || '',
                'Quốc tịch': obj.nationality || '',
                'Dân tộc': obj.ethnicity || '',
                'Tôn giáo': obj.religion || '',
                'Số CMND/CCCD': obj.idNumber || '',
                'Cấp ngày': formatDateToVietnamese(obj.issueDate) || '',
                'Nơi cấp': obj.issuePlace || '',
                'Trình độ học vấn': obj.education || '',
                'Nghề nghiệp': obj.occupation || '',
                'Nơi làm việc': obj.workplace || '',
                'Nơi thường trú': obj.permanentAddress || '',
                'Số điện thoại': obj.phoneNumber || '',
                'Nơi tạm trú': obj.temporaryResidence || '',
                'Nơi ở hiện tại': obj.currentResidence || '',
                'Hoàn cảnh gia đình': obj.familyBackground || '',
                'Mối quan hệ': obj.relationship || '',
                'Hình thức xử lý': obj.handlingMethod || '',
                'Hành vi': Array.isArray(obj.behavior) ? obj.behavior.join(', ') : obj.behavior || '',
                'Hình thức xử phạt': obj.penaltyForm || '',
                'Số Biên bản XPHC': obj.administrativeRecordNumber || '',
                'Số Quyết định XPHC': obj.administrativeDecisionNumber || '',
                'Ngày lập biên bản': formatDateToVietnamese(obj.reportDate) || '',
                'Ngày ra QĐ xử phạt': formatDateToVietnamese(obj.decisionDate) || '',
                'Ngày khởi tố': formatDateToVietnamese(obj.prosecutionDateObj) || '',
                'Số QĐ khởi tố': obj.prosecutionDecisionObj || '',
                'Ngày quyết định tạm giam': formatDateToVietnamese(obj.detentionDecisionDate) || '',
                'Số quyết định tạm giam': obj.detentionDecisionNumber || '',
                'Ngày quyết định tạm giữ': formatDateToVietnamese(obj.custodyDecisionDate) || '',
                'Số quyết định tạm giữ': obj.custodyDecisionNumber || '',
                'Loại tội phạm': obj.crimeType || '',
                'Số lần gia hạn tạm giữ': obj.custodyExtensionCount || '',
                'Ngày hết hạn tạm giữ': formatDateToVietnamese(obj.custodyExpirationDate) || '',
                'Số lần gia hạn tạm giam': obj.detentionExtensionCount || '',
                'Ngày hết hạn tạm giam': formatDateToVietnamese(obj.detentionExpirationDate) || ''
              });
            });
          }
        });
        const wb = XLSX.utils.book_new();
        const wsCases = XLSX.utils.json_to_sheet(casesData);
        const rangeCases = XLSX.utils.decode_range(wsCases['!ref']);
        for (let C = rangeCases.s.c; C <= rangeCases.e.c; ++C) {
          const cell = XLSX.utils.encode_cell({r: 0, c: C});
          if (!wsCases[cell]) continue;
          wsCases[cell].s = { font: { bold: true }, alignment: { horizontal: 'center' } };
        }
        wsCases['!cols'] = casesData[0] ? Object.keys(casesData[0]).map(key => ({ wch: Math.max(key.length, 15) })) : [];
        XLSX.utils.book_append_sheet(wb, wsCases, 'Vụ Việc');
        if (objectsData.length > 0) {
          const wsObjects = XLSX.utils.json_to_sheet(objectsData);
          const rangeObjects = XLSX.utils.decode_range(wsObjects['!ref']);
          for (let C = rangeObjects.s.c; C <= rangeObjects.e.c; ++C) {
            const cell = XLSX.utils.encode_cell({r: 0, c: C});
            if (!wsObjects[cell]) continue;
            wsObjects[cell].s = { font: { bold: true }, alignment: { horizontal: 'center' } };
          }
          wsObjects['!cols'] = objectsData[0] ? Object.keys(objectsData[0]).map(key => ({ wch: Math.max(key.length, 20) })) : [];
          XLSX.utils.book_append_sheet(wb, wsObjects, 'Đối Tượng');
        }
        XLSX.writeFile(wb, 'DanhSachVuViec.xlsx');
      } catch (error) {
        console.error('Lỗi khi xuất file Excel:', error);
        return 'Không thể xuất file Excel. Vui lòng kiểm tra dữ liệu và thử lại.';
      }
      return null;
    }
  </script>
  <script type="text/babel">
    const { useState, useEffect, useMemo, useRef } = React;
    const { Document, Packer, Paragraph, TextRun, AlignmentType, Table, TableRow, TableCell, WidthType, BorderStyle } = window.docx;
    const defaultCaseTypes = [
      "Điều 123. Tội giết người",
      "Điều 124. Tội giết hoặc vứt bỏ con mới đẻ",
      "Điều 125. Tội giết người trong trạng thái tinh thần bị kích động mạnh",
      "Điều 126. Tội giết người do vượt quá giới hạn phòng vệ chính đáng hoặc do vượt quá mức cần thiết khi bắt giữ người phạm tội",
      "Điều 127. Tội làm chết người trong khi thi hành công vụ",
      "Điều 128. Tội vô ý làm chết người",
      "Điều 129. Tội vô ý làm chết người do vi phạm quy tắc nghề nghiệp hoặc quy tắc hành chính",
      "Điều 130. Tội bức tử",
      "Điều 131. Tội xúi giục hoặc giúp người khác tự sát",
      "Điều 132. Tội không cứu giúp người đang ở trong tình trạng nguy hiểm đến tính mạng",
      "Điều 133. Tội đe dọa giết người",
      "Điều 134. Tội cố ý gây thương tích hoặc gây tổn hại cho sức khỏe của người khác",
      "Điều 135. Tội cố ý gây thương tích hoặc gây tổn hại cho sức khỏe của người khác trong trạng thái tinh thần bị kích động mạnh",
      "Điều 136. Tội cố ý gây thương tích hoặc gây tổn hại cho sức khỏe của người khác do vượt quá giới hạn phòng vệ chính đáng hoặc do vượt quá mức cần thiết khi bắt giữ người phạm tội",
      "Điều 137. Tội gây thương tích hoặc gây tổn hại cho sức khỏe của người khác trong khi thi hành công vụ",
      "Điều 138. Tội vô ý gây thương tích hoặc gây tổn hại cho sức khỏe của người khác",
      "Điều 139. Tội vô ý gây thương tích hoặc gây tổn hại cho sức khỏe của người khác do vi phạm quy tắc nghề nghiệp hoặc quy tắc hành chính",
      "Điều 140. Tội hành hạ người khác",
      "Điều 141. Tội hiếp dâm",
      "Điều 142. Tội hiếp dâm người dưới 16 tuổi",
      "Điều 143. Tội cưỡng dâm",
      "Điều 144. Tội cưỡng dâm người từ đủ 13 tuổi đến dưới 16 tuổi",
      "Điều 145. Tội giao cấu hoặc thực hiện hành vi quan hệ tình dục khác với người từ đủ 13 tuổi đến dưới 16 tuổi",
      "Điều 146. Tội dâm ô đối với người dưới 16 tuổi",
      "Điều 147. Tội sử dụng người dưới 16 tuổi vào mục đích khiêu dâm",
      "Điều 148. Tội lây truyền HIV cho người khác",
      "Điều 149. Tội cố ý truyền HIV cho người khác",
      "Điều 150. Tội mua bán người",
      "Điều 151. Tội mua bán người dưới 16 tuổi",
      "Điều 152. Tội đánh tráo người dưới 01 tuổi",
      "Điều 153. Tội chiếm đoạt người dưới 16 tuổi",
      "Điều 154. Tội mua bán, chiếm đoạt mô hoặc bộ phận cơ thể người",
      "Điều 155. Tội làm nhục người khác",
      "Điều 156. Tội vu khống",
      "Điều 157. Tội bắt, giữ hoặc giam người trái pháp luật",
      "Điều 158. Tội xâm phạm chỗ ở của người khác",
      "Điều 159. Tội xâm phạm bí mật hoặc an toàn thư tín, điện thoại, điện tín hoặc hình thức trao đổi thông tin riêng tư khác của người khác",
      "Điều 160. Tội xâm phạm quyền của công dân về bầu cử, ứng cử hoặc biểu quyết khi Nhà nước trưng cầu ý dân",
      "Điều 161. Tội làm sai lệch kết quả bầu cử, kết quả trưng cầu ý dân",
      "Điều 162. Tội buộc công chức, viên chức thôi việc hoặc sa thải người lao động trái pháp luật",
      "Điều 163. Tội xâm phạm quyền hội họp, lập hội của công dân",
      "Điều 164. Tội xâm phạm quyền tự do tín ngưỡng, tôn giáo của người khác",
      "Điều 165. Tội xâm phạm quyền bình đẳng giới",
      "Điều 166. Tội xâm phạm quyền khiếu nại, tố cáo",
      "Điều 167. Tội xâm phạm quyền tự do ngôn luận, tự do báo chí, tiếp cận thông tin, quyền biểu tình của công dân",
      "Điều 168. Tội cướp tài sản",
      "Điều 169. Tội bắt cóc nhằm chiếm đoạt tài sản",
      "Điều 170. Tội cưỡng đoạt tài sản",
      "Điều 171. Tội cướp giật tài sản",
      "Điều 172. Tội trộm cắp tài sản",
      "Điều 173. Tội công nhiên chiếm đoạt tài sản",
      "Điều 174. Tội lừa đảo chiếm đoạt tài sản",
      "Điều 175. Tội lạm dụng tín nhiệm chiếm đoạt tài sản",
      "Điều 176. Tội sử dụng trái phép tài sản",
      "Điều 177. Tội hủy hoại hoặc cố ý làm hư hỏng tài sản",
      "Điều 178. Tội vô ý làm hư hỏng tài sản",
      "Điều 248. Tội sản xuất trái phép chất ma túy",
      "Điều 249. Tội tàng trữ trái phép chất ma túy",
      "Điều 250. Tội vận chuyển trái phép chất ma túy",
      "Điều 251. Tội mua bán trái phép chất ma túy",
      "Điều 252. Tội tổ chức sử dụng trái phép chất ma túy",
      "Điều 253. Tội chứa chấp việc sử dụng trái phép chất ma túy",
      "Điều 254. Tội sử dụng trái phép chất ma túy",
      "Điều 255. Tội cưỡng ép người khác sử dụng trái phép chất ma túy",
      "Điều 256. Tội lôi kéo người khác sử dụng trái phép chất ma túy",
      "Điều 257. Tội sản xuất, mua bán, vận chuyển, tàng trữ phương tiện, dụng cụ dùng vào việc sản xuất hoặc sử dụng trái phép chất ma túy",
      "Điều 258. Tội vi phạm các quy định về quản lý chất ma túy"
    ];
    const defaultAssignees = [
      "ĐTV: Trương Văn Thon",
      "ĐTV: Ngô Lam Thanh"
    ];
    const defaultReceivingUnits = [
      "PC01",
      "PC02",
      "PC03",
      "PC04"
    ];
    const religions = [
      "Không",
      "Phật",
      "Công giáo"
    ];
    const genders = [
      "Nam",
      "Nữ"
    ];
    const issuePlaces = [
      "Cục cảnh sát Quản lý hành chính về trật tự xã hội",
      "Bộ công an"
    ];
    const handlingMethods = [
      "xử phạt hành chính",
      "khởi tố bị can"
    ];
    const investigationResults = [
      "khởi tố vụ án",
      "xử phạt hành chính",
      "tin báo",
      "Chuyển hồ sơ"
    ];
    const crimeTypes = [
      "Tội phạm ít nghiêm trọng",
      "Tội phạm nghiêm trọng",
      "Tội phạm rất nghiêm trọng",
      "Tội phạm đặc biệt nghiêm trọng"
    ];
    const initialInvestigationMonths = {
      "Tội phạm ít nghiêm trọng": 2,
      "Tội phạm nghiêm trọng": 3,
      "Tội phạm rất nghiêm trọng": 4,
      "Tội phạm đặc biệt nghiêm trọng": 4
    };
    const extensionInvestigationMonths = {
      "Tội phạm ít nghiêm trọng": [2],
      "Tội phạm nghiêm trọng": [3, 2],
      "Tội phạm rất nghiêm trọng": [4, 4],
      "Tội phạm đặc biệt nghiêm trọng": [4, 4, 4]
    };
    const maxInvestigationExtensions = {
      "Tội phạm ít nghiêm trọng": 1,
      "Tội phạm nghiêm trọng": 2,
      "Tội phạm rất nghiêm trọng": 2,
      "Tội phạm đặc biệt nghiêm trọng": 3
    };
    const initialDetentionDays = {
      "Tội phạm ít nghiêm trọng": 60,
      "Tội phạm nghiêm trọng": 90,
      "Tội phạm rất nghiêm trọng": 120,
      "Tội phạm đặc biệt nghiêm trọng": 120
    };
    const extensionDetentionDays = {
      "Tội phạm ít nghiêm trọng": [30],
      "Tội phạm nghiêm trọng": [60],
      "Tội phạm rất nghiêm trọng": [90],
      "Tội phạm đặc biệt nghiêm trọng": [120, 120]
    };
    const maxDetentionExtensions = {
      "Tội phạm ít nghiêm trọng": 1,
      "Tội phạm nghiêm trọng": 1,
      "Tội phạm rất nghiêm trọng": 1,
      "Tội phạm đặc biệt nghiêm trọng": 2
    };
    const calculateTotalInvestigationMonths = (crimeType, extensionCount) => {
      let total = initialInvestigationMonths[crimeType] || 0;
      const exts = extensionInvestigationMonths[crimeType] || [];
      for (let i = 0; i < extensionCount && i < exts.length; i++) {
        total += exts[i];
      }
      return total;
    };
    const calculateTotalDetentionDays = (crimeType, extensionCount) => {
      let total = initialDetentionDays[crimeType] || 0;
      const exts = extensionDetentionDays[crimeType] || [];
      for (let i = 0; i < extensionCount && i < exts.length; i++) {
        total += exts[i];
      }
      return total;
    };
    const formatDateToVietnamese = (dateStr) => {
      if (!dateStr || !/^\d{4}-\d{2}-\d{2}$/.test(dateStr)) return '';
      const [year, month, day] = dateStr.split('-');
      return `${day.padStart(2, '0')}/${month.padStart(2, '0')}/${year}`;
    };
    const parseDateFromVietnamese = (dateStr) => {
      if (!dateStr || !/^\d{2}\/\d{2}\/\d{4}$/.test(dateStr)) return '';
      const [day, month, year] = dateStr.split('/');
      return `${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')}`;
    };
    const formatDateToFullVietnamese = (dateStr) => {
      if (!dateStr) return '';
      const [year, month, day] = dateStr.split('-');
      return `ngày ${day.padStart(2, '0')} tháng ${month.padStart(2, '0')} năm ${year}`;
    };
    const addMonthsToDate = (dateStr, months) => {
      if (!dateStr) return '';
      const date = new Date(dateStr);
      date.setMonth(date.getMonth() + months);
      return date.toISOString().split('T')[0];
    };
    const addDaysToDate = (dateStr, days) => {
      if (!dateStr) return '';
      const date = new Date(dateStr);
      date.setDate(date.getDate() + days);
      return date.toISOString().split('T')[0];
    };
    const sortCaseTypes = (list) => {
      return list.sort((a, b) => {
        const matchA = a.match(/Điều (\d+)([a-z]?)/);
        const matchB = b.match(/Điều (\d+)([a-z]?)/);
        if (!matchA || !matchB) return 0;
        const numA = parseInt(matchA[1]);
        const numB = parseInt(matchB[1]);
        if (numA !== numB) return numA - numB;
        return (matchA[2] || ' ').localeCompare(matchB[2] || ' ');
      });
    };
    const EditListsModal = ({ showEditLists, setShowEditLists, selectedList, setSelectedList, caseTypesList, setCaseTypesList, assigneesList, setAssigneesList, receivingUnitsList, setReceivingUnitsList, handlingMethodsList, setHandlingMethodsList, setErrorMessage }) => {
      const [newItem, setNewItem] = useState('');
      const handleAddItem = () => {
        if (!newItem.trim()) return;
        let updatedList;
        switch (selectedList) {
          case 'caseTypes':
            updatedList = sortCaseTypes([...caseTypesList, newItem]);
            setCaseTypesList(updatedList);
            break;
          case 'assignees':
            updatedList = [...assigneesList, newItem].sort();
            setAssigneesList(updatedList);
            break;
          case 'receivingUnits':
            updatedList = [...receivingUnitsList, newItem].sort();
            setReceivingUnitsList(updatedList);
            break;
          case 'handlingMethods':
            updatedList = [...handlingMethodsList, newItem].sort();
            setHandlingMethodsList(updatedList);
            break;
        }
        setNewItem('');
      };
      const handleDeleteItem = (index) => {
        switch (selectedList) {
          case 'caseTypes':
            setCaseTypesList(caseTypesList.filter((_, i) => i !== index));
            break;
          case 'assignees':
            setAssigneesList(assigneesList.filter((_, i) => i !== index));
            break;
          case 'receivingUnits':
            setReceivingUnitsList(receivingUnitsList.filter((_, i) => i !== index));
            break;
          case 'handlingMethods':
            setHandlingMethodsList(handlingMethodsList.filter((_, i) => i !== index));
            break;
        }
      };
      const handleSave = async () => {
        try {
          await saveListsToDB({
            caseTypes: caseTypesList,
            assignees: assigneesList,
            receivingUnits: receivingUnitsList,
            handlingMethods: handlingMethodsList
          });
          setShowEditLists(false);
        } catch (error) {
          setErrorMessage('Lỗi khi lưu danh sách.');
        }
      };
      const getCurrentList = () => {
        switch (selectedList) {
          case 'caseTypes':
            return caseTypesList;
          case 'assignees':
            return assigneesList;
          case 'receivingUnits':
            return receivingUnitsList;
          case 'handlingMethods':
            return handlingMethodsList;
          default:
            return [];
        }
      };
      if (!showEditLists) return null;
      return (
        <div className="fixed inset-0 flex items-center justify-center bg-black bg-opacity-50">
          <div className="bg-white p-4 rounded shadow w-1/2">
            <h2 className="text-xl font-bold mb-4">Chỉnh Sửa Danh Sách</h2>
            <select
              value={selectedList}
              onChange={(e) => setSelectedList(e.target.value)}
              className="border p-2 rounded w-full mb-4"
            >
              <option value="">Chọn danh sách</option>
              <option value="caseTypes">Loại vụ việc</option>
              <option value="assignees">Người thụ lý chính</option>
              <option value="receivingUnits">Đơn vị tiếp nhận</option>
              <option value="handlingMethods">Hình thức xử lý</option>
            </select>
            {selectedList && (
              <>
                <div className="mb-4">
                  <input
                    type="text"
                    value={newItem}
                    onChange={(e) => setNewItem(e.target.value)}
                    placeholder="Nhập mục mới"
                    className="border p-2 rounded w-full mb-2"
                  />
                  <button
                    className="bg-green-500 text-white px-4 py-2 rounded"
                    onClick={handleAddItem}
                  >
                    Thêm
                  </button>
                </div>
                <div className="max-h-60 overflow-y-auto border p-2 rounded">
                  <ul className="list-disc pl-5">
                    {getCurrentList().map((item, index) => (
                      <li key={index} className="flex justify-between items-center mb-2">
                        {item}
                        <button
                          className="bg-red-500 text-white px-2 py-1 rounded"
                          onClick={() => handleDeleteItem(index)}
                        >
                          Xóa
                        </button>
                      </li>
                    ))}
                  </ul>
                </div>
              </>
            )}
            <div className="mt-4">
              <button
                className="bg-green-500 text-white px-4 py-2 rounded mr-2"
                onClick={handleSave}
              >
                Lưu
              </button>
              <button
                className="bg-gray-500 text-white px-4 py-2 rounded"
                onClick={() => setShowEditLists(false)}
              >
                Hủy
              </button>
            </div>
          </div>
        </div>
      );
    };
    const ObjectForm = ({ objectData, setObjectData, tempObjects, setTempObjects, editingIndex, setEditingIndex, setShowObjectForm, handleSubmitObject, exportResume, caseData, setErrorMessage, caseTypesList, handlingMethodsList }) => {
      const [previousValues, setPreviousValues] = useState({});
      const [currentBehavior, setCurrentBehavior] = useState('');
      const [filteredBehaviors, setFilteredBehaviors] = useState(caseTypesList);
      const birthDateRef = useRef(null);
      const issueDateRef = useRef(null);
      const reportDateRef = useRef(null);
      const decisionDateRef = useRef(null);
      const prosecutionDateObjRef = useRef(null);
      const custodyDecisionDateRef = useRef(null);
      const detentionDecisionDateRef = useRef(null);
      const flatpickrInstances = useRef({});
      useEffect(() => {
        setPreviousValues({ ...objectData });
      }, []);
      useEffect(() => {
        if (objectData.handlingMethod === 'khởi tố bị can') {
          if (objectData.custodyDecisionDate) {
            let ext = parseInt(objectData.custodyExtensionCount) || 0;
            let days = 3 + 3 * Math.min(ext, 2);
            setObjectData(prev => ({ ...prev, custodyExpirationDate: addDaysToDate(prev.custodyDecisionDate, days) }));
          }
          if (objectData.detentionDecisionDate && objectData.crimeType) {
            let totalDays = calculateTotalDetentionDays(objectData.crimeType, parseInt(objectData.detentionExtensionCount) || 0);
            setObjectData(prev => ({ ...prev, detentionExpirationDate: addDaysToDate(prev.detentionDecisionDate, totalDays) }));
          }
        }
      }, [objectData.custodyDecisionDate, objectData.custodyExtensionCount, objectData.detentionDecisionDate, objectData.detentionExtensionCount, objectData.crimeType, objectData.handlingMethod]);
      useEffect(() => {
        const dl = daysLeft(objectData.detentionExpirationDate);
        const maxExt = maxDetentionExtensions[objectData.crimeType] || 0;
        const extCount = parseInt(objectData.detentionExtensionCount) || 0;
        if (dl <= 10 && extCount < maxExt) {
          setErrorMessage('Yêu cầu gia hạn tạm giam');
        } else if (dl <= 10 && extCount >= maxExt && caseData.status !== 'hoàn thành') {
          setErrorMessage('Yêu cầu hoàn thành vụ việc');
        } else {
          setErrorMessage(null);
        }
      }, [objectData.detentionExpirationDate, objectData.detentionExtensionCount, objectData.crimeType, caseData.status]);
      useEffect(() => {
        if (birthDateRef.current && !flatpickrInstances.current.birthDate) {
          flatpickrInstances.current.birthDate = flatpickr(birthDateRef.current, {
            dateFormat: "d/m/Y",
            defaultDate: formatDateToVietnamese(objectData.birthDate),
            onChange: ([date]) => {
              if (date) {
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                const dateStr = `${day}/${month}/${year}`;
                handleObjectInputChange({ target: { name: 'birthDate', value: dateStr } });
              }
            }
          });
        }
        if (issueDateRef.current && !flatpickrInstances.current.issueDate) {
          flatpickrInstances.current.issueDate = flatpickr(issueDateRef.current, {
            dateFormat: "d/m/Y",
            defaultDate: formatDateToVietnamese(objectData.issueDate),
            onChange: ([date]) => {
              if (date) {
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                const dateStr = `${day}/${month}/${year}`;
                handleObjectInputChange({ target: { name: 'issueDate', value: dateStr } });
              }
            }
          });
        }
        if (objectData.handlingMethod === 'xử phạt hành chính') {
          if (reportDateRef.current && !flatpickrInstances.current.reportDate) {
            flatpickrInstances.current.reportDate = flatpickr(reportDateRef.current, {
              dateFormat: "d/m/Y",
              defaultDate: formatDateToVietnamese(objectData.reportDate),
              onChange: ([date]) => {
                if (date) {
                  const year = date.getFullYear();
                  const month = String(date.getMonth() + 1).padStart(2, '0');
                  const day = String(date.getDate()).padStart(2, '0');
                  const dateStr = `${day}/${month}/${year}`;
                  handleObjectInputChange({ target: { name: 'reportDate', value: dateStr } });
                }
              }
            });
          }
          if (decisionDateRef.current && !flatpickrInstances.current.decisionDate) {
            flatpickrInstances.current.decisionDate = flatpickr(decisionDateRef.current, {
              dateFormat: "d/m/Y",
              defaultDate: formatDateToVietnamese(objectData.decisionDate),
              onChange: ([date]) => {
                if (date) {
                  const year = date.getFullYear();
                  const month = String(date.getMonth() + 1).padStart(2, '0');
                  const day = String(date.getDate()).padStart(2, '0');
                  const dateStr = `${day}/${month}/${year}`;
                  handleObjectInputChange({ target: { name: 'decisionDate', value: dateStr } });
                }
              }
            });
          }
        }
        if (objectData.handlingMethod === 'khởi tố bị can') {
          if (prosecutionDateObjRef.current && !flatpickrInstances.current.prosecutionDateObj) {
            flatpickrInstances.current.prosecutionDateObj = flatpickr(prosecutionDateObjRef.current, {
              dateFormat: "d/m/Y",
              defaultDate: formatDateToVietnamese(objectData.prosecutionDateObj),
              onChange: ([date]) => {
                if (date) {
                  const year = date.getFullYear();
                  const month = String(date.getMonth() + 1).padStart(2, '0');
                  const day = String(date.getDate()).padStart(2, '0');
                  const dateStr = `${day}/${month}/${year}`;
                  handleObjectInputChange({ target: { name: 'prosecutionDateObj', value: dateStr } });
                }
              }
            });
          }
          if (custodyDecisionDateRef.current && !flatpickrInstances.current.custodyDecisionDate) {
            flatpickrInstances.current.custodyDecisionDate = flatpickr(custodyDecisionDateRef.current, {
              dateFormat: "d/m/Y",
              defaultDate: formatDateToVietnamese(objectData.custodyDecisionDate),
              onChange: ([date]) => {
                if (date) {
                  const year = date.getFullYear();
                  const month = String(date.getMonth() + 1).padStart(2, '0');
                  const day = String(date.getDate()).padStart(2, '0');
                  const dateStr = `${day}/${month}/${year}`;
                  handleObjectInputChange({ target: { name: 'custodyDecisionDate', value: dateStr } });
                }
              }
            });
          }
          if (detentionDecisionDateRef.current && !flatpickrInstances.current.detentionDecisionDate) {
            flatpickrInstances.current.detentionDecisionDate = flatpickr(detentionDecisionDateRef.current, {
              dateFormat: "d/m/Y",
              defaultDate: formatDateToVietnamese(objectData.detentionDecisionDate),
              onChange: ([date]) => {
                if (date) {
                  const year = date.getFullYear();
                  const month = String(date.getMonth() + 1).padStart(2, '0');
                  const day = String(date.getDate()).padStart(2, '0');
                  const dateStr = `${day}/${month}/${year}`;
                  handleObjectInputChange({ target: { name: 'detentionDecisionDate', value: dateStr } });
                }
              }
            });
          }
        }
        return () => {
          Object.values(flatpickrInstances.current).forEach(instance => instance?.destroy());
          flatpickrInstances.current = {};
        };
      }, [objectData.handlingMethod]);
      const handleObjectInputChange = (e) => {
        const { name, value } = e.target;
        setObjectData(prev => {
          if (name === 'behavior') {
            const selectedBehaviors = value.split(',').map(b => b.trim()).filter(b => b);
            return { ...prev, [name]: selectedBehaviors };
          } else if (['birthDate', 'issueDate', 'reportDate', 'decisionDate', 'prosecutionDateObj', 'custodyDecisionDate', 'detentionDecisionDate'].includes(name)) {
            return { ...prev, [name]: parseDateFromVietnamese(value) };
          } else {
            return { ...prev, [name]: value };
          }
        });
      };
      const handleCurrentBehaviorChange = (e) => {
        const value = e.target.value;
        setCurrentBehavior(value);
        setFilteredBehaviors(
          caseTypesList.filter(
            ct => ct.toLowerCase().includes(value.toLowerCase()) && (!objectData.behavior || !objectData.behavior.includes(ct))
          )
        );
      };
      const addBehavior = () => {
        if (currentBehavior && caseTypesList.includes(currentBehavior) && (!objectData.behavior || !objectData.behavior.includes(currentBehavior)) ) {
          setObjectData({ ...objectData, behavior: [...(objectData.behavior || []), currentBehavior] });
          setCurrentBehavior('');
          setFilteredBehaviors(caseTypesList.filter(ct => !objectData.behavior || !objectData.behavior.includes(ct)));
        }
      };
      const removeBehavior = (index) => {
        const newBehaviors = objectData.behavior.filter((_, i) => i !== index);
        setObjectData({ ...objectData, behavior: newBehaviors });
      };
      const handleUndoField = (name) => {
        setObjectData({ ...objectData, [name]: previousValues[name] || '' });
      };
      const renderUndoButton = (name) => {
        if (objectData[name] !== previousValues[name]) {
          return (
            <button
              className="bg-green-500 text-white px-2 py-1 rounded ml-2 text-sm active:scale-95 active:opacity-75 transition-transform"
              onClick={() => handleUndoField(name)}
            >
              Ok
            </button>
          );
        }
        return null;
      };
      const handlePhotoUpload = (e) => {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (event) => {
          const img = new Image();
          img.onload = () => {
            const canvas = document.createElement('canvas');
            const width = 113; // 3cm ≈ 113px at 96dpi
            const height = 151; // 4cm ≈ 151px at 96dpi
            canvas.width = width;
            canvas.height = height;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(img, 0, 0, width, height);
            const resizedBase64 = canvas.toDataURL('image/jpeg');
            setObjectData({ ...objectData, photo: resizedBase64 });
          };
          img.src = event.target.result;
        };
        reader.readAsDataURL(file);
      };
      const exportPhoto = () => {
        if (!objectData.photo) {
          setErrorMessage('Không có ảnh để xuất.');
          return;
        }
        const byteString = atob(objectData.photo.split(',')[1]);
        const ab = new ArrayBuffer(byteString.length);
        const ia = new Uint8Array(ab);
        for (let i = 0; i < byteString.length; i++) {
          ia[i] = byteString.charCodeAt(i);
        }
        const blob = new Blob([ab], { type: 'image/jpeg' });
        saveAs(blob, `${objectData.name || 'anh_doi_tuong'}.jpg`);
      };
      const exportCompactInfo = () => {
        if (!objectData.name) {
          setErrorMessage('Vui lòng nhập ít nhất họ tên để xuất thông tin gọn.');
          return;
        }
        const getBirthYear = (dateStr) => {
          if (!dateStr) return '';
          return dateStr.split('-')[0];
        };
        try {
          const doc = new Document({
            sections: [{
              properties: {
                page: {
                  margins: {
                    top: 1134,
                    right: 1134,
                    bottom: 1134,
                    left: 1417
                  }
                }
              },
              children: [
                new Paragraph({
                  children: [
                    new TextRun({ text: `Thông tin gọn ${objectData.name || 'Đối tượng'}`, font: { name: 'Times New Roman', fallback: 'Arial' }, size: 28, bold: true })
                  ],
                  alignment: AlignmentType.CENTER,
                  spacing: { after: 200 }
                }),
                new Paragraph({
                  children: [
                    new TextRun({ text: 'Họ tên: ', font: { name: 'Times New Roman', fallback: 'Arial' }, size: 28, bold: true }),
                    new TextRun({ text: objectData.name || '', font: { name: 'Times New Roman', fallback: 'Arial' }, size: 28 }),
                    new TextRun({ text: ' (sinh năm ', font: { name: 'Times New Roman', fallback: 'Arial' }, size: 28, bold: true }),
                    new TextRun({ text: getBirthYear(objectData.birthDate) || '', font: { name: 'Times New Roman', fallback: 'Arial' }, size: 28 }),
                    new TextRun({ text: ', nơi thường trú: ', font: { name: 'Times New Roman', fallback: 'Arial' }, size: 28, bold: true }),
                    new TextRun({ text: objectData.permanentAddress || '', font: { name: 'Times New Roman', fallback: 'Arial' }, size: 28 }),
                    new TextRun({ text: ', nơi ở hiện tại: ', font: { name: 'Times New Roman', fallback: 'Arial' }, size: 28, bold: true }),
                    new TextRun({ text: objectData.currentResidence || '', font: { name: 'Times New Roman', fallback: 'Arial' }, size: 28 }),
                    new TextRun({ text: ')', font: { name: 'Times New Roman', fallback: 'Arial' }, size: 28, bold: true })
                  ],
                  spacing: { after: 100 }
                }),
                new Paragraph({
                  children: [
                    new TextRun({ text: 'Nội dung vụ việc: ', font: { name: 'Times New Roman', fallback: 'Arial' }, size: 28, bold: true }),
                    new TextRun({ text: caseData.description || '', font: { name: 'Times New Roman', fallback: 'Arial' }, size: 28 })
                  ],
                  spacing: { after: 100 }
                })
              ]
            }]
          });
          Packer.toBlob(doc).then((blob) => {
            saveAs(blob, `thông tin nhanh ${objectData.name || 'Đối tượng'}.docx`);
            setShowObjectForm(false);
          }).catch(error => {
            console.error('Lỗi khi xuất thông tin gọn:', error);
            setErrorMessage('Không thể xuất file Word. Vui lòng kiểm tra dữ liệu và thử lại.');
          });
        } catch (error) {
          console.error('Lỗi khi xuất thông tin gọn:', error);
          setErrorMessage('Không thể xuất file Word. Vui lòng kiểm tra dữ liệu và thử lại.');
        }
      };
      const daysLeft = (expDate) => {
        if (!expDate) return Infinity;
        const exp = new Date(expDate);
        const now = new Date();
        return Math.floor((exp - now) / (1000 * 60 * 60 * 24));
      };
      const isCustodyRed = daysLeft(objectData.custodyExpirationDate) <= 2 && (!objectData.detentionDecisionDate || !objectData.detentionDecisionNumber);
      const isDetentionRed = () => {
        const dl = daysLeft(objectData.detentionExpirationDate);
        if (dl <= 10) return true;
        return false;
      };
      const getDetentionColor = () => {
        const dl = daysLeft(objectData.detentionExpirationDate);
        if (dl <= 10) return 'text-red-500';
        return 'text-green-500';
      };
      return (
        <div className="bg-white p-4 shadow rounded">
          <h2 className="text-xl font-bold mb-4">{editingIndex !== null ? "Chỉnh Sửa Đối Tượng" : "Thêm Thông Tin Đối Tượng"}</h2>
          <div className="grid grid-cols-2 gap-4">
            <div className="flex items-center">
              <div className="flex-1">
                <label className="block mb-1 font-medium">Họ tên</label>
                <input
                  type="text"
                  name="name"
                  value={objectData.name || ''}
                  onChange={handleObjectInputChange}
                  placeholder="Nhập họ tên"
                  className="border p-2 rounded w-full"
                />
              </div>
              {renderUndoButton('name')}
            </div>
            <div className="flex items-center">
              <div className="flex-1">
                <label className="block mb-1 font-medium">Giới tính</label>
                <select
                  name="gender"
                  value={objectData.gender || ''}
                  onChange={handleObjectInputChange}
                  className="border p-2 rounded w-full"
                >
                  <option value="">Chọn giới tính</option>
                  {genders.map((gender, index) => (
                    <option key={index} value={gender}>{gender}</option>
                  ))}
                </select>
              </div>
              {renderUndoButton('gender')}
            </div>
            <div className="flex items-center">
              <div className="flex-1">
                <label className="block mb-1 font-medium">Tên gọi khác</label>
                <input
                  type="text"
                  name="alias"
                  value={objectData.alias || 'Không'}
                  onChange={handleObjectInputChange}
                  placeholder="Nhập tên gọi khác"
                  className="border p-2 rounded w-full"
                />
              </div>
              {renderUndoButton('alias')}
            </div>
            <div className="flex items-center">
              <div className="flex-1">
                <label className="block mb-1 font-medium">Sinh ngày</label>
                <input
                  type="text"
                  ref={birthDateRef}
                  name="birthDate"
                  placeholder="dd/mm/yyyy"
                  className="border p-2 rounded w-full"
                />
              </div>
              {renderUndoButton('birthDate')}
            </div>
            <div className="flex items-center">
              <div className="flex-1">
                <label className="block mb-1 font-medium">Tại</label>
                <input
                  type="text"
                  name="birthPlace"
                  value={objectData.birthPlace || ''}
                  onChange={handleObjectInputChange}
                  placeholder="Nhập nơi sinh"
                  className="border p-2 rounded w-full"
                />
              </div>
              {renderUndoButton('birthPlace')}
            </div>
            <div className="flex items-center">
              <div className="flex-1">
                <label className="block mb-1 font-medium">Quê quán</label>
                <input
                  type="text"
                  name="hometown"
                  value={objectData.hometown || ''}
                  onChange={handleObjectInputChange}
                  placeholder="Nhập quê quán"
                  className="border p-2 rounded w-full"
                />
              </div>
              {renderUndoButton('hometown')}
            </div>
            <div className="flex items-center">
              <div className="flex-1">
                <label className="block mb-1 font-medium">Quốc tịch</label>
                <input
                  type="text"
                  name="nationality"
                  value={objectData.nationality || 'Việt Nam'}
                  onChange={handleObjectInputChange}
                  placeholder="Nhập quốc tịch"
                  className="border p-2 rounded w-full"
                />
              </div>
              {renderUndoButton('nationality')}
            </div>
            <div className="flex items-center">
              <div className="flex-1">
                <label className="block mb-1 font-medium">Dân tộc</label>
                <input
                  type="text"
                  name="ethnicity"
                  value={objectData.ethnicity || 'Kinh'}
                  onChange={handleObjectInputChange}
                  placeholder="Nhập dân tộc"
                  className="border p-2 rounded w-full"
                />
              </div>
              {renderUndoButton('ethnicity')}
            </div>
            <div className="flex items-center">
              <div className="flex-1">
                <label className="block mb-1 font-medium">Tôn giáo</label>
                <select
                  name="religion"
                  value={objectData.religion || 'Không'}
                  onChange={handleObjectInputChange}
                  className="border p-2 rounded w-full"
                >
                  {religions.map((religion, index) => (
                    <option key={index} value={religion}>{religion}</option>
                  ))}
                </select>
              </div>
              {renderUndoButton('religion')}
            </div>
            <div className="flex items-center">
              <div className="flex-1">
                <label className="block mb-1 font-medium">Số CMND/Thẻ CCCD/Hộ chiếu</label>
                <input
                  type="text"
                  name="idNumber"
                  value={objectData.idNumber || ''}
                  onChange={handleObjectInputChange}
                  placeholder="Nhập số CMND/CCCD/Hộ chiếu"
                  className="border p-2 rounded w-full"
                />
              </div>
              {renderUndoButton('idNumber')}
            </div>
            <div className="flex items-center">
              <div className="flex-1">
                <label className="block mb-1 font-medium">Cấp ngày</label>
                <input
                  type="text"
                  ref={issueDateRef}
                  name="issueDate"
                  placeholder="dd/mm/yyyy"
                  className="border p-2 rounded w-full"
                />
              </div>
              {renderUndoButton('issueDate')}
            </div>
            <div className="flex items-center">
              <div className="flex-1">
                <label className="block mb-1 font-medium">Nơi cấp</label>
                <input
                  type="text"
                  name="issuePlace"
                  value={objectData.issuePlace || ''}
                  onChange={handleObjectInputChange}
                  placeholder="Nhập hoặc chọn nơi cấp"
                  className="border p-2 rounded w-full"
                  list="issuePlaces"
                />
                <datalist id="issuePlaces">
                  {issuePlaces.map((place, index) => (
                    <option key={index} value={place} />
                  ))}
                </datalist>
              </div>
              {renderUndoButton('issuePlace')}
            </div>
            <div className="flex items-center">
              <div className="flex-1">
                <label className="block mb-1 font-medium">Trình độ học vấn</label>
                <input
                  type="text"
                  name="education"
                  value={objectData.education || '/12'}
                  onChange={handleObjectInputChange}
                  placeholder="Nhập trình độ học vấn"
                  className="border p-2 rounded w-full"
                />
              </div>
              {renderUndoButton('education')}
            </div>
            <div className="flex items-center">
              <div className="flex-1">
                <label className="block mb-1 font-medium">Nghề nghiệp</label>
                <input
                  type="text"
                  name="occupation"
                  value={objectData.occupation || ''}
                  onChange={handleObjectInputChange}
                  placeholder="Nhập nghề nghiệp"
                  className="border p-2 rounded w-full"
                />
              </div>
              {renderUndoButton('occupation')}
            </div>
            <div className="flex items-center">
              <div className="flex-1">
                <label className="block mb-1 font-medium">Nơi làm việc</label>
                <input
                  type="text"
                  name="workplace"
                  value={objectData.workplace || ''}
                  onChange={handleObjectInputChange}
                  placeholder="Nhập nơi làm việc"
                  className="border p-2 rounded w-full"
                />
              </div>
              {renderUndoButton('workplace')}
            </div>
            <div className="flex items-center">
              <div className="flex-1">
                <label className="block mb-1 font-medium">Nơi thường trú</label>
                <input
                  type="text"
                  name="permanentAddress"
                  value={objectData.permanentAddress || ''}
                  onChange={handleObjectInputChange}
                  placeholder="Nhập nơi thường trú"
                  className="border p-2 rounded w-full"
                />
              </div>
              {renderUndoButton('permanentAddress')}
            </div>
            <div className="flex items-center">
              <div className="flex-1">
                <label className="block mb-1 font-medium">Số điện thoại</label>
                <input
                  type="text"
                  name="phoneNumber"
                  value={objectData.phoneNumber || ''}
                  onChange={handleObjectInputChange}
                  placeholder="Nhập số điện thoại"
                  className="border p-2 rounded w-full"
                />
              </div>
              {renderUndoButton('phoneNumber')}
            </div>
            <div className="flex items-center">
              <div className="flex-1">
                <label className="block mb-1 font-medium">Nơi tạm trú</label>
                <input
                  type="text"
                  name="temporaryResidence"
                  value={objectData.temporaryResidence || ''}
                  onChange={handleObjectInputChange}
                  placeholder="Nhập nơi tạm trú"
                  className="border p-2 rounded w-full"
                />
              </div>
              {renderUndoButton('temporaryResidence')}
            </div>
            <div className="flex items-center">
              <div className="flex-1">
                <label className="block mb-1 font-medium">Nơi ở hiện tại</label>
                <input
                  type="text"
                  name="currentResidence"
                  value={objectData.currentResidence || ''}
                  onChange={handleObjectInputChange}
                  placeholder="Nhập nơi ở hiện tại"
                  className="border p-2 rounded w-full"
                />
              </div>
              {renderUndoButton('currentResidence')}
            </div>
            <div className="flex items-center">
              <div className="flex-1">
                <label className="block mb-1 font-medium">Mối quan hệ với các đối tượng</label>
                <input
                  type="text"
                  name="relationship"
                  value={objectData.relationship || ''}
                  onChange={handleObjectInputChange}
                  placeholder="Nhập mối quan hệ"
                  className="border p-2 rounded w-full"
                />
              </div>
              {renderUndoButton('relationship')}
            </div>
            <div className="flex items-center col-span-2">
              <div className="flex-1">
                <label className="block mb-1 font-medium">Hoàn cảnh gia đình</label>
                <textarea
                  name="familyBackground"
                  value={objectData.familyBackground || 'Cha: Sinh năm: Nghề nghiệp: Nơi ở hiện tại:'}
                  onChange={handleObjectInputChange}
                  placeholder="Nhập hoàn cảnh gia đình"
                  className="border p-2 rounded w-full"
                />
              </div>
              {renderUndoButton('familyBackground')}
            </div>
            <div className="flex items-center">
              <div className="flex-1">
                <label className="block mb-1 font-medium">Hình thức xử lý</label>
                <select
                  name="handlingMethod"
                  value={objectData.handlingMethod || ''}
                  onChange={handleObjectInputChange}
                  className="border p-2 rounded w-full"
                >
                  <option value="">Chọn hình thức xử lý</option>
                  {handlingMethodsList.map((method, index) => (
                    <option key={index} value={method}>{method}</option>
                  ))}
                </select>
              </div>
              {renderUndoButton('handlingMethod')}
            </div>
            {objectData.handlingMethod === 'xử phạt hành chính' && (
              <>
                <div className="flex items-center">
                  <div className="flex-1">
                    <label className="block mb-1 font-medium">Hành vi</label>
                    <input
                      type="text"
                      name="behavior"
                      value={objectData.behavior || ''}
                      onChange={handleObjectInputChange}
                      placeholder="Nhập hành vi"
                      className="border p-2 rounded w-full"
                    />
                  </div>
                  {renderUndoButton('behavior')}
                </div>
                <div className="flex items-center">
                  <div className="flex-1">
                    <label className="block mb-1 font-medium">Hình thức xử phạt</label>
                    <input
                      type="text"
                      name="penaltyForm"
                      value={objectData.penaltyForm || ''}
                      onChange={handleObjectInputChange}
                      placeholder="Nhập hình thức xử phạt"
                      className="border p-2 rounded w-full"
                    />
                  </div>
                  {renderUndoButton('penaltyForm')}
                </div>
                <div className="flex items-center">
                  <div className="flex-1">
                    <label className="block mb-1 font-medium">Số Biên bản XPHC</label>
                    <input
                      type="text"
                      name="administrativeRecordNumber"
                      value={objectData.administrativeRecordNumber || ''}
                      onChange={handleObjectInputChange}
                      placeholder="Nhập số biên bản XPHC"
                      className="border p-2 rounded w-full"
                    />
                  </div>
                  {renderUndoButton('administrativeRecordNumber')}
                </div>
                <div className="flex items-center">
                  <div className="flex-1">
                    <label className="block mb-1 font-medium">Số Quyết định XPHC</label>
                    <input
                      type="text"
                      name="administrativeDecisionNumber"
                      value={objectData.administrativeDecisionNumber || ''}
                      onChange={handleObjectInputChange}
                      placeholder="Nhập số quyết định XPHC"
                      className="border p-2 rounded w-full"
                    />
                  </div>
                  {renderUndoButton('administrativeDecisionNumber')}
                </div>
                <div className="flex items-center">
                  <div className="flex-1">
                    <label className="block mb-1 font-medium">Ngày lập biên bản</label>
                    <input
                      type="text"
                      ref={reportDateRef}
                      name="reportDate"
                      placeholder="dd/mm/yyyy"
                      className="border p-2 rounded w-full"
                    />
                  </div>
                  {renderUndoButton('reportDate')}
                </div>
                <div className="flex items-center">
                  <div className="flex-1">
                    <label className="block mb-1 font-medium">Ngày ra QĐ xử phạt</label>
                    <input
                      type="text"
                      ref={decisionDateRef}
                      name="decisionDate"
                      placeholder="dd/mm/yyyy"
                      className="border p-2 rounded w-full"
                    />
                  </div>
                  {renderUndoButton('decisionDate')}
                </div>
              </>
            )}
            {objectData.handlingMethod === 'khởi tố bị can' && (
              <>
                <div className="flex items-center col-span-2">
                  <div className="flex-1">
                    <label className="block mb-1 font-medium">Hành vi</label>
                    <input
                      type="text"
                      value={currentBehavior}
                      onChange={handleCurrentBehaviorChange}
                      placeholder="Nhập hành vi để tìm kiếm"
                      className="border p-2 rounded w-full"
                      list="behaviorList"
                    />
                    <datalist id="behaviorList">
                      {filteredBehaviors.map((behavior, index) => (
                        <option key={index} value={behavior} />
                      ))}
                    </datalist>
                    <button
                      className="bg-blue-500 text-white px-4 py-2 rounded mt-2"
                      onClick={addBehavior}
                      disabled={!currentBehavior}
                    >
                      Thêm
                    </button>
                    <div className="mt-2">
                      {objectData.behavior && objectData.behavior.map((behavior, index) => (
                        <span key={index} className="inline-block bg-gray-200 rounded px-2 py-1 mr-2 mb-2">
                          {behavior}
                          <button
                            className="ml-2 text-red-500"
                            onClick={() => removeBehavior(index)}
                          >
                            ×
                          </button>
                        </span>
                      ))}
                    </div>
                  </div>
                  {renderUndoButton('behavior')}
                </div>
                <div className="flex items-center">
                  <div className="flex-1">
                    <label className="block mb-1 font-medium">Hình thức xử phạt</label>
                    <input
                      type="text"
                      name="penaltyForm"
                      value={objectData.penaltyForm || ''}
                      onChange={handleObjectInputChange}
                      placeholder="Nhập hình thức xử phạt"
                      className="border p-2 rounded w-full"
                    />
                  </div>
                  {renderUndoButton('penaltyForm')}
                </div>
                <div className="flex items-center">
                  <div className="flex-1">
                    <label className="block mb-1 font-medium">Loại tội phạm</label>
                    <select
                      name="crimeType"
                      value={objectData.crimeType || ''}
                      onChange={handleObjectInputChange}
                      className="border p-2 rounded w-full"
                    >
                      <option value="">Chọn loại tội phạm</option>
                      {crimeTypes.map((type, index) => (
                        <option key={index} value={type}>{type}</option>
                      ))}
                    </select>
                  </div>
                  {renderUndoButton('crimeType')}
                </div>
                <div className="flex items-center">
                  <div className="flex-1">
                    <label className="block mb-1 font-medium">Ngày khởi tố</label>
                    <input
                      type="text"
                      ref={prosecutionDateObjRef}
                      name="prosecutionDateObj"
                      placeholder="dd/mm/yyyy"
                      className="border p-2 rounded w-full"
                    />
                  </div>
                  {renderUndoButton('prosecutionDateObj')}
                </div>
                <div className="flex items-center">
                  <div className="flex-1">
                    <label className="block mb-1 font-medium">Số QĐ khởi tố</label>
                    <input
                      type="text"
                      name="prosecutionDecisionObj"
                      value={objectData.prosecutionDecisionObj || ''}
                      onChange={handleObjectInputChange}
                      placeholder="Nhập số QĐ khởi tố"
                      className="border p-2 rounded w-full"
                    />
                  </div>
                  {renderUndoButton('prosecutionDecisionObj')}
                </div>
                <div className="flex items-center">
                  <div className="flex-1">
                    <label className="block mb-1 font-medium">Ngày quyết định tạm giữ</label>
                    <input
                      type="text"
                      ref={custodyDecisionDateRef}
                      name="custodyDecisionDate"
                      placeholder="dd/mm/yyyy"
                      className="border p-2 rounded w-full"
                    />
                  </div>
                  {renderUndoButton('custodyDecisionDate')}
                </div>
                <div className="flex items-center">
                  <div className="flex-1">
                    <label className="block mb-1 font-medium">Số quyết định tạm giữ</label>
                    <input
                      type="text"
                      name="custodyDecisionNumber"
                      value={objectData.custodyDecisionNumber || ''}
                      onChange={handleObjectInputChange}
                      placeholder="Nhập số quyết định tạm giữ"
                      className="border p-2 rounded w-full"
                    />
                  </div>
                  {renderUndoButton('custodyDecisionNumber')}
                </div>
                <div className="flex items-center">
                  <div className="flex-1">
                    <label className="block mb-1 font-medium">Số lần gia hạn tạm giữ</label>
                    <select
                      name="custodyExtensionCount"
                      value={objectData.custodyExtensionCount || '0'}
                      onChange={handleObjectInputChange}
                      className="border p-2 rounded w-full"
                    >
                      {[0, 1, 2].map((n) => (
                        <option key={n} value={n}>
                          {n}
                        </option>
                      ))}
                    </select>
                  </div>
                  {renderUndoButton('custodyExtensionCount')}
                </div>
                <div className="flex items-center">
                  <div className="flex-1">
                    <label className="block mb-1 font-medium">Ngày hết hạn tạm giữ</label>
                    <input
                      type="text"
                      name="custodyExpirationDate"
                      value={formatDateToVietnamese(objectData.custodyExpirationDate) || ''}
                      className={`border p-2 rounded w-full bg-gray-100 ${isCustodyRed ? 'text-red-500' : 'text-green-500'}`}
                      readOnly
                    />
                  </div>
                </div>
                <div className="flex items-center">
                  <div className="flex-1">
                    <label className="block mb-1 font-medium">Ngày quyết định tạm giam</label>
                    <input
                      type="text"
                      ref={detentionDecisionDateRef}
                      name="detentionDecisionDate"
                      placeholder="dd/mm/yyyy"
                      className="border p-2 rounded w-full"
                    />
                  </div>
                  {renderUndoButton('detentionDecisionDate')}
                </div>
                <div className="flex items-center">
                  <div className="flex-1">
                    <label className="block mb-1 font-medium">Số quyết định tạm giam</label>
                    <input
                      type="text"
                      name="detentionDecisionNumber"
                      value={objectData.detentionDecisionNumber || ''}
                      onChange={handleObjectInputChange}
                      placeholder="Nhập số quyết định tạm giam"
                      className="border p-2 rounded w-full"
                    />
                  </div>
                  {renderUndoButton('detentionDecisionNumber')}
                </div>
                <div className="flex items-center">
                  <div className="flex-1">
                    <label className="block mb-1 font-medium">Số lần gia hạn tạm giam</label>
                    <select
                      name="detentionExtensionCount"
                      value={objectData.detentionExtensionCount || '0'}
                      onChange={handleObjectInputChange}
                      className="border p-2 rounded w-full"
                      disabled={!objectData.crimeType}
                    >
                      {Array.from({ length: (maxDetentionExtensions[objectData.crimeType] || 0) + 1 }, (_, i) => (
                        <option key={i} value={i}>
                          {i}
                        </option>
                      ))}
                    </select>
                  </div>
                  {renderUndoButton('detentionExtensionCount')}
                </div>
                <div className="flex items-center">
                  <div className="flex-1">
                    <label className="block mb-1 font-medium">Ngày hết hạn tạm giam</label>
                    <input
                      type="text"
                      name="detentionExpirationDate"
                      value={formatDateToVietnamese(objectData.detentionExpirationDate) || ''}
                      className={`border p-2 rounded w-full bg-gray-100 ${isDetentionRed() ? 'text-red-500' : 'text-green-500'}`}
                      readOnly
                    />
                  </div>
                </div>
              </>
            )}
            <div className="col-span-2">
              <label className="block mb-1 font-medium">Ảnh (3cm x 4cm)</label>
              <div className="flex gap-4">
                <div className="photo-container">
                  {objectData.photo ? (
                    <img src={objectData.photo} alt="Ảnh đối tượng" />
                  ) : (
                    <div className="w-full h-full bg-gray-200 flex items-center justify-center">Không có ảnh</div>
                  )}
                </div>
                <div className="flex flex-col gap-2">
                  <label className="bg-blue-500 text-white px-4 py-2 rounded cursor-pointer">
                    Thêm ảnh
                    <input
                      type="file"
                      accept="image/*"
                      onChange={handlePhotoUpload}
                      className="hidden"
                    />
                  </label>
                  <button
                    className="bg-blue-500 text-white px-4 py-2 rounded"
                    onClick={exportPhoto}
                  >
                    Xuất ảnh
                  </button>
                </div>
              </div>
            </div>
          </div>
          <div className="mt-4">
            <button
              className="bg-green-500 text-white px-4 py-2 rounded mr-2 active:scale-95 active:opacity-75 transition-transform"
              onClick={handleSubmitObject}
            >
              Lưu
            </button>
            <button
              className="bg-blue-500 text-white px-4 py-2 rounded mr-2 active:scale-95 active:opacity-75 transition-transform"
              onClick={exportResume}
            >
              Lý lịch
            </button>
            <button
              className="bg-gray-500 text-white px-4 py-2 rounded mr-2 active:scale-95 active:opacity-75 transition-transform"
              onClick={exportCompactInfo}
            >
              Thông tin gọn
            </button>
            <button
              className="bg-gray-500 text-white px-4 py-2 rounded active:scale-95 active:opacity-75 transition-transform"
              onClick={() => setShowObjectForm(false)}
            >
              Hủy
            </button>
          </div>
        </div>
      );
    };
    const CaseForm = ({ caseData, setCaseData, tempObjects, setTempObjects, editingCaseId, isEditing, setIsEditing, setShowForm, setViewMode, cases, setCases, setShowObjectForm, setObjectData, setEditingIndex, setDeleteIndex, setShowConfirm, setUndoData, setErrorMessage, setSuccessMessage, assigneesList, receivingUnitsList, caseTypesList, handlingMethodsList }) => {
      const [typeInput, setTypeInput] = useState(caseData.type.join(', '));
      const [currentType, setCurrentType] = useState('');
      const [filteredCaseTypes, setFilteredCaseTypes] = useState(caseTypesList);
      const dateReceivedRef = useRef(null);
      const investigationConclusionDateRef = useRef(null);
      const prosecutionDateRef = useRef(null);
      const penaltyDateRef = useRef(null);
      const transferDateRef = useRef(null);
      const reportDateRef = useRef(null);
      const flatpickrInstances = useRef({});
      useEffect(() => {
        if (caseData.investigationResult === 'khởi tố vụ án' && caseData.prosecutionDate && caseData.crimeType) {
          const totalMonths = calculateTotalInvestigationMonths(caseData.crimeType, caseData.extensionCount);
          const newExpirationDate = addMonthsToDate(caseData.prosecutionDate, totalMonths);
          setCaseData(prev => ({ ...prev, expirationDate: newExpirationDate }));
        }
      }, [caseData.prosecutionDate, caseData.crimeType, caseData.extensionCount]);
      useEffect(() => {
        const dl = daysLeft(caseData.expirationDate);
        const maxExt = maxInvestigationExtensions[caseData.crimeType] || 0;
        const extCount = caseData.extensionCount || 0;
        const isAtMax = extCount >= maxExt;
        const isCompleted = caseData.status === 'hoàn thành';
        if (dl <= 10 && extCount < maxExt) {
          setErrorMessage('Yêu cầu gia hạn điều tra');
        } else if (dl <= 10 && isAtMax && !isCompleted) {
          setErrorMessage('Yêu cầu hoàn thành vụ việc');
        } else {
          setErrorMessage(null);
        }
      }, [caseData.expirationDate, caseData.extensionCount, caseData.crimeType, caseData.status]);
      useEffect(() => {
        if (dateReceivedRef.current && !flatpickrInstances.current.dateReceived) {
          flatpickrInstances.current.dateReceived = flatpickr(dateReceivedRef.current, {
            dateFormat: "d/m/Y",
            defaultDate: formatDateToVietnamese(caseData.dateReceived),
            onChange: ([date]) => {
              if (date) {
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                const dateStr = `${day}/${month}/${year}`;
                handleInputChange({ target: { name: 'dateReceived', value: dateStr } });
              }
            },
            disableMobile: true
          });
        }
        if (caseData.investigationResult === 'khởi tố vụ án') {
          if (investigationConclusionDateRef.current && !flatpickrInstances.current.investigationConclusionDate) {
            flatpickrInstances.current.investigationConclusionDate = flatpickr(investigationConclusionDateRef.current, {
              dateFormat: "d/m/Y",
              defaultDate: formatDateToVietnamese(caseData.investigationConclusionDate),
              onChange: ([date]) => {
                if (date) {
                  const year = date.getFullYear();
                  const month = String(date.getMonth() + 1).padStart(2, '0');
                  const day = String(date.getDate()).padStart(2, '0');
                  const dateStr = `${day}/${month}/${year}`;
                  handleInputChange({ target: { name: 'investigationConclusionDate', value: dateStr } });
                }
              }
            });
          }
          if (prosecutionDateRef.current && !flatpickrInstances.current.prosecutionDate) {
            flatpickrInstances.current.prosecutionDate = flatpickr(prosecutionDateRef.current, {
              dateFormat: "d/m/Y",
              defaultDate: formatDateToVietnamese(caseData.prosecutionDate),
              onChange: ([date]) => {
                if (date) {
                  const year = date.getFullYear();
                  const month = String(date.getMonth() + 1).padStart(2, '0');
                  const day = String(date.getDate()).padStart(2, '0');
                  const dateStr = `${day}/${month}/${year}`;
                  handleInputChange({ target: { name: 'prosecutionDate', value: dateStr } });
                }
              }
            });
          }
        }
        if (caseData.investigationResult === 'xử phạt hành chính') {
          if (penaltyDateRef.current && !flatpickrInstances.current.penaltyDate) {
            flatpickrInstances.current.penaltyDate = flatpickr(penaltyDateRef.current, {
              dateFormat: "d/m/Y",
              defaultDate: formatDateToVietnamese(caseData.penaltyDate),
              onChange: ([date]) => {
                if (date) {
                  const year = date.getFullYear();
                  const month = String(date.getMonth() + 1).padStart(2, '0');
                  const day = String(date.getDate()).padStart(2, '0');
                  const dateStr = `${day}/${month}/${year}`;
                  handleInputChange({ target: { name: 'penaltyDate', value: dateStr } });
                }
              }
            });
          }
        }
        if (caseData.investigationResult === 'tin báo') {
          if (reportDateRef.current && !flatpickrInstances.current.reportDate) {
            flatpickrInstances.current.reportDate = flatpickr(reportDateRef.current, {
              dateFormat: "d/m/Y",
              defaultDate: formatDateToVietnamese(caseData.reportDate),
              onChange: ([date]) => {
                if (date) {
                  const year = date.getFullYear();
                  const month = String(date.getMonth() + 1).padStart(2, '0');
                  const day = String(date.getDate()).padStart(2, '0');
                  const dateStr = `${day}/${month}/${year}`;
                  handleInputChange({ target: { name: 'reportDate', value: dateStr } });
                }
              }
            });
          }
        }
        if (caseData.investigationResult === 'Chuyển hồ sơ') {
          if (transferDateRef.current && !flatpickrInstances.current.transferDate) {
            flatpickrInstances.current.transferDate = flatpickr(transferDateRef.current, {
              dateFormat: "d/m/Y",
              defaultDate: formatDateToVietnamese(caseData.transferDate),
              onChange: ([date]) => {
                if (date) {
                  const year = date.getFullYear();
                  const month = String(date.getMonth() + 1).padStart(2, '0');
                  const day = String(date.getDate()).padStart(2, '0');
                  const dateStr = `${day}/${month}/${year}`;
                  handleInputChange({ target: { name: 'transferDate', value: dateStr } });
                }
              }
            });
          }
        }
        return () => {
          Object.values(flatpickrInstances.current).forEach(instance => instance?.destroy());
          flatpickrInstances.current = {};
        };
      }, [caseData.investigationResult]);
      const handleInputChange = (e) => {
        const { name, value } = e.target;
        setCaseData(prev => {
          let newCaseData = { ...prev };
          if (name === 'type') {
            setTypeInput(value);
            const selectedTypes = value.split(',').map(t => t.trim()).filter(t => t);
            newCaseData = { ...prev, [name]: selectedTypes };
          } else if (name === 'reportDate') {
            newCaseData = { ...prev, [name]: parseDateFromVietnamese(value) };
            if (!newCaseData.expirationDate) {
              newCaseData.expirationDate = addMonthsToDate(parseDateFromVietnamese(value), 4);
            }
          } else if (['dateReceived', 'investigationConclusionDate', 'prosecutionDate', 'penaltyDate', 'transferDate'].includes(name)) {
            newCaseData = { ...prev, [name]: parseDateFromVietnamese(value) };
          } else {
            newCaseData = { ...prev, [name]: value };
          }
          return newCaseData;
        });
      };
      const handleCurrentTypeChange = (e) => {
        const value = e.target.value;
        setCurrentType(value);
        setFilteredCaseTypes(
          caseTypesList.filter(
            ct => ct.toLowerCase().includes(value.toLowerCase()) && !caseData.type.includes(ct)
          )
        );
      };
      const addType = () => {
        if (currentType && caseTypesList.includes(currentType) && !caseData.type.includes(currentType)) {
          setCaseData({ ...caseData, type: [...caseData.type, currentType] });
          setTypeInput([...caseData.type, currentType].join(', '));
          setCurrentType('');
          setFilteredCaseTypes(caseTypesList.filter(ct => !caseData.type.includes(ct)));
        }
      };
      const handleAddObjectClick = () => {
        console.log('handleAddObjectClick called, setting showObjectForm to true');
        setEditingIndex(null);
        setObjectData({
          name: '',
          gender: '',
          alias: 'Không',
          birthDate: '',
          birthPlace: '',
          hometown: '',
          nationality: 'Việt Nam',
          ethnicity: 'Kinh',
          religion: 'Không',
          idNumber: '',
          issueDate: '',
          issuePlace: '',
          education: '',
          occupation: '',
          workplace: '',
          permanentAddress: '',
          phoneNumber: '',
          temporaryResidence: '',
          currentResidence: '',
          familyBackground: '',
          relationship: '',
          handlingMethod: '',
          behavior: [],
          penaltyForm: '',
          administrativeRecordNumber: '',
          administrativeDecisionNumber: '',
          reportDate: '',
          decisionDate: '',
          prosecutionDateObj: '',
          prosecutionDecisionObj: '',
          detentionDecisionDate: '',
          detentionDecisionNumber: '',
          custodyDecisionDate: '',
          custodyDecisionNumber: '',
          crimeType: '',
          custodyExtensionCount: '0',
          detentionExtensionCount: '0',
          custodyExpirationDate: '',
          detentionExpirationDate: '',
          photo: ''
        });
        setShowObjectForm(true);
      };
      const handleEditObject = (index) => {
        console.log('Editing object at index:', index);
        setObjectData(tempObjects[index]);
        setEditingIndex(index);
        setShowObjectForm(true);
      };
      const handleDeleteConfirm = (index) => {
        console.log('handleDeleteConfirm called with index:', index);
        setDeleteIndex(index);
        setTimeout(() => setShowConfirm(true), 0);
      };
      const handleSubmitCase = (e) => {
        e.preventDefault();
        console.log('Submitting case:', caseData);
        console.log('Temp objects:', tempObjects);
        if (!caseData.id || !caseData.type || caseData.type.length === 0 || !caseData.dateReceived) {
          setErrorMessage('Vui lòng điền đầy đủ các trường bắt buộc: Mã số vụ, Loại vụ việc, Ngày tiếp nhận.');
          return;
        }
        if (!editingCaseId && cases.some(c => c.id === caseData.id)) {
          setErrorMessage('Mã số vụ đã tồn tại. Vui lòng chọn mã số khác.');
          return;
        }
        console.log('Updating cases...');
        if (editingCaseId !== null) {
          const updatedCases = cases.map((c) =>
            c.id === editingCaseId ? { ...caseData, objects: tempObjects } : c
          );
          setCases(updatedCases);
        } else {
          setCases([...cases, { ...caseData, objects: tempObjects, id: caseData.id }]);
        }
        console.log('Cases updated:', cases);
        setCaseData({
          id: '',
          type: [], // Đặt lại thành mảng rỗng
          dateReceived: '',
          description: '',
          seizedItems: '',
          assignee: '',
          directAssignee: '',
          investigationResult: '',
          crimeType: '',
          extensionCount: 0,
          investigationConclusionDate: '',
          prosecutionDate: '',
          prosecutionDecision: '',
          penaltyDate: '',
          penaltyDecision: '',
          transferDate: '',
          receivingUnit: '',
          status: 'đang thực hiện',
          reportDate: '',
          expirationDate: '',
          notes: '',
          objects: []
        });
        setTempObjects([]);
        setShowForm(false);
        setIsEditing(false);
        setViewMode('list');
        setSuccessMessage('Vụ việc đã được lưu thành công.');
      };
      const daysLeft = (expDate) => {
        if (!expDate) return Infinity;
        const exp = new Date(expDate);
        const now = new Date();
        return Math.floor((exp - now) / (1000 * 60 * 60 * 24));
      };
      const showRedCustody = (obj) => {
        const dl = daysLeft(obj.custodyExpirationDate);
        return dl <= 2 && (!obj.detentionDecisionDate || !obj.detentionDecisionNumber);
      };
      const showRedDetention = (obj, status) => {
        const dl = daysLeft(obj.detentionExpirationDate);
        if (dl > 10) return false;
        const maxExt = maxDetentionExtensions[obj.crimeType] || 0;
        const extCount = parseInt(obj.detentionExtensionCount) || 0;
        const isAtMax = extCount >= maxExt;
        const isCompleted = status === 'hoàn thành';
        return !isAtMax || (isAtMax && !isCompleted);
      };
      const getDetentionColor = (obj, status) => {
        const dl = daysLeft(obj.detentionExpirationDate);
        if (dl <= 10) return 'text-red-500';
        return 'text-green-500';
      };
      const isInvestigationRed = () => {
        const dl = daysLeft(caseData.expirationDate);
        if (dl > 10) return false;
        const maxExt = maxInvestigationExtensions[caseData.crimeType] || 0;
        const extCount = caseData.extensionCount || 0;
        const isAtMax = extCount >= maxExt;
        const isCompleted = caseData.status === 'hoàn thành';
        return !isAtMax || (isAtMax && !isCompleted);
      };
      const getInvestigationColor = () => {
        const dl = daysLeft(caseData.expirationDate);
        if (dl <= 10) return 'text-red-500';
        return 'text-green-500';
      };
      return (
        <div className="bg-white p-4 shadow rounded">
          <h2 className="text-xl font-bold mb-4">{editingCaseId ? "Chỉnh Sửa Vụ Việc" : "Thêm Vụ Việc Mới"}</h2>
          <div className="grid grid-cols-2 gap-4">
            <div>
              <label className="block mb-1 font-medium">Mã số vụ</label>
              <input
                type="text"
                name="id"
                value={caseData.id}
                onChange={handleInputChange}
                placeholder="Nhập mã số vụ"
                className="border p-2 rounded w-full"
                readOnly={!isEditing}
              />
            </div>
            <div>
              <label className="block mb-1 font-medium">Loại vụ việc</label>
              <input
                type="text"
                name="type"
                value={typeInput}
                onChange={handleInputChange}
                placeholder="Nhập loại vụ việc, cách nhau bằng dấu phẩy"
                className="border p-2 rounded w-full"
                disabled={!isEditing}
              />
              <input
                type="text"
                value={currentType}
                onChange={handleCurrentTypeChange}
                placeholder="Tìm kiếm để thêm"
                className="border p-2 rounded w-full mt-2"
                list="caseTypesList"
                disabled={!isEditing}
              />
              <datalist id="caseTypesList">
                {filteredCaseTypes.map((type, index) => (
                  <option key={index} value={type} />
                ))}
              </datalist>
              <button
                className="bg-blue-500 text-white px-4 py-2 rounded mt-2"
                onClick={addType}
                disabled={!isEditing || !currentType}
              >
                Thêm
              </button>
            </div>
            <div>
              <label className="block mb-1 font-medium">Ngày tiếp nhận</label>
              <input
                type="text"
                ref={dateReceivedRef}
                name="dateReceived"
                placeholder="dd/mm/yyyy"
                className="border p-2 rounded w-full"
                readOnly={!isEditing}
              />
            </div>
            <div className="col-span-2">
              <label className="block mb-1 font-medium">Nội dung vụ việc</label>
              <textarea
                name="description"
                value={caseData.description || ''}
                onChange={handleInputChange}
                placeholder="Nhập nội dung vụ việc"
                className="border p-2 rounded w-full"
                readOnly={!isEditing}
              />
            </div>
            <div className="col-span-2">
              <label className="block mb-1 font-medium">Đồ vật, tài liệu bị tạm giữ</label>
              <textarea
                name="seizedItems"
                value={caseData.seizedItems || ''}
                onChange={handleInputChange}
                placeholder="Nhập đồ vật, tài liệu bị tạm giữ"
                className="border p-2 rounded w-full"
                readOnly={!isEditing}
              />
            </div>
            <div>
              <label className="block mb-1 font-medium">Người thụ lý chính</label>
              <input
                type="text"
                name="assignee"
                value={caseData.assignee}
                onChange={handleInputChange}
                placeholder="Nhập hoặc chọn người thụ lý"
                className="border p-2 rounded w-full"
                list="assignees"
                disabled={!isEditing}
              />
              <datalist id="assignees">
                {assigneesList.map((assignee, index) => (
                  <option key={index} value={assignee} />
                ))}
              </datalist>
            </div>
            <div>
              <label className="block mb-1 font-medium">Người trực tiếp làm</label>
              <input
                type="text"
                name="directAssignee"
                value={caseData.directAssignee}
                onChange={handleInputChange}
                placeholder="Nhập người trực tiếp làm"
                className="border p-2 rounded w-full"
                readOnly={!isEditing}
              />
            </div>
            <div>
              <label className="block mb-1 font-medium">Kết quả điều tra</label>
              <select
                name="investigationResult"
                value={caseData.investigationResult}
                onChange={handleInputChange}
                className="border p-2 rounded w-full"
                disabled={!isEditing}
              >
                <option value="">Chọn kết quả điều tra</option>
                {investigationResults.map((result, index) => (
                  <option key={index} value={result}>{result}</option>
                ))}
              </select>
            </div>
            {caseData.investigationResult === 'khởi tố vụ án' && (
              <>
                <div>
                  <label className="block mb-1 font-medium">Loại tội phạm</label>
                  <select
                    name="crimeType"
                    value={caseData.crimeType || ''}
                    onChange={handleInputChange}
                    className="border p-2 rounded w-full"
                    disabled={!isEditing}
                  >
                    <option value="">Chọn loại tội phạm</option>
                    {crimeTypes.map((type, index) => (
                      <option key={index} value={type}>{type}</option>
                    ))}
                  </select>
                </div>
                <div>
                  <label className="block mb-1 font-medium">Số lần gia hạn</label>
                  <select
                    name="extensionCount"
                    value={caseData.extensionCount || 0}
                    onChange={handleInputChange}
                    className="border p-2 rounded w-full"
                    disabled={!isEditing}
                  >
                    {Array.from({ length: (maxInvestigationExtensions[caseData.crimeType] || 0) + 1 }, (_, i) => (
                      <option key={i} value={i}>
                        {i}
                      </option>
                    ))}
                  </select>
                </div>
                <div>
                  <label className="block mb-1 font-medium">Ngày kết luận điều tra</label>
                  <input
                    type="text"
                    ref={investigationConclusionDateRef}
                    name="investigationConclusionDate"
                    placeholder="dd/mm/yyyy"
                    className="border p-2 rounded w-full"
                    disabled={!isEditing}
                  />
                </div>
                <div>
                  <label className="block mb-1 font-medium">Ngày hết hạn điều tra</label>
                  <input
                    type="text"
                    name="expirationDate"
                    value={formatDateToVietnamese(caseData.expirationDate) || ''}
                    className={`border p-2 rounded w-full bg-gray-100 ${isInvestigationRed() ? 'text-red-500' : 'text-green-500'}`}
                    readOnly
                  />
                </div>
                <div>
                  <label className="block mb-1 font-medium">Ngày khởi tố vụ án</label>
                  <input
                    type="text"
                    ref={prosecutionDateRef}
                    name="prosecutionDate"
                    placeholder="dd/mm/yyyy"
                    className="border p-2 rounded w-full"
                    readOnly={!isEditing}
                  />
                </div>
                <div>
                  <label className="block mb-1 font-medium">Số QĐ khởi tố vụ án</label>
                  <input
                    type="text"
                    name="prosecutionDecision"
                    value={caseData.prosecutionDecision}
                    onChange={handleInputChange}
                    placeholder="Nhập số QĐ khởi tố vụ án"
                    className="border p-2 rounded w-full"
                    readOnly={!isEditing}
                  />
                </div>
              </>
            )}
            {caseData.investigationResult === 'xử phạt hành chính' && (
              <>
                <div>
                  <label className="block mb-1 font-medium">Ngày QĐ xử phạt</label>
                  <input
                    type="text"
                    ref={penaltyDateRef}
                    name="penaltyDate"
                    placeholder="dd/mm/yyyy"
                    className="border p-2 rounded w-full"
                    readOnly={!isEditing}
                  />
                </div>
                <div>
                  <label className="block mb-1 font-medium">Số QĐ xử phạt</label>
                  <input
                    type="text"
                    name="penaltyDecision"
                    value={caseData.penaltyDecision}
                    onChange={handleInputChange}
                    placeholder="Nhập số QĐ xử phạt"
                    className="border p-2 rounded w-full"
                    readOnly={!isEditing}
                  />
                </div>
              </>
            )}
            {caseData.investigationResult === 'tin báo' && (
              <>
                <div>
                  <label className="block mb-1 font-medium">Ngày lên tin báo</label>
                  <input
                    type="text"
                    ref={reportDateRef}
                    name="reportDate"
                    placeholder="dd/mm/yyyy"
                    className="border p-2 rounded w-full"
                    readOnly={!isEditing}
                  />
                </div>
                <div>
                  <label className="block mb-1 font-medium">Ngày hết hạn tin báo</label>
                  <input
                    type="text"
                    name="expirationDate"
                    value={formatDateToVietnamese(caseData.expirationDate) || ''}
                    onChange={handleInputChange}
                    placeholder="dd/mm/yyyy"
                    className="border p-2 rounded w-full"
                    pattern="\d{2}/\d{2}/\d{4}"
                    readOnly={!isEditing}
                  />
                </div>
              </>
            )}
            {caseData.investigationResult === 'Chuyển hồ sơ' && (
              <>
                <div>
                  <label className="block mb-1 font-medium">Ngày chuyển</label>
                  <input
                    type="text"
                    ref={transferDateRef}
                    name="transferDate"
                    placeholder="dd/mm/yyyy"
                    className="border p-2 rounded w-full"
                    readOnly={!isEditing}
                  />
                </div>
                <div>
                  <label className="block mb-1 font-medium">Đơn vị tiếp nhận</label>
                  <input
                    type="text"
                    name="receivingUnit"
                    value={caseData.receivingUnit}
                    onChange={handleInputChange}
                    placeholder="Nhập hoặc chọn đơn vị tiếp nhận"
                    className="border p-2 rounded w-full"
                    list="receivingUnits"
                    disabled={!isEditing}
                  />
                  <datalist id="receivingUnits">
                    {receivingUnitsList.map((unit, index) => (
                      <option key={index} value={unit} />
                    ))}
                  </datalist>
                </div>
              </>
            )}
            <div>
              <label className="block mb-1 font-medium">Trạng thái</label>
              <select
                name="status"
                value={caseData.status}
                onChange={handleInputChange}
                className="border p-2 rounded w-full"
                disabled={!isEditing}
              >
                <option value="đang thực hiện">Đang thực hiện</option>
                <option value="hoàn thành">Hoàn thành</option>
              </select>
            </div>
            <div className="col-span-2">
              <label className="block mb-1 font-medium">Ghi chú</label>
              <textarea
                name="notes"
                value={caseData.notes || ''}
                onChange={handleInputChange}
                placeholder="Nhập ghi chú"
                className="border p-2 rounded w-full"
                readOnly={!isEditing}
              />
            </div>
            <div>
              <label className="block mb-1 font-medium">Số đối tượng</label>
              <input
                type="text"
                value={tempObjects.length}
                readOnly
                className="border p-2 rounded w-full bg-gray-100"
              />
            </div>
            <div>
              <label className="block mb-1 font-medium">Thêm đối tượng</label>
              <button
                className="bg-blue-500 text-white px-4 py-2 rounded active:scale-95 active:opacity-75 transition-transform"
                onClick={handleAddObjectClick}
              >
                Thêm đối tượng
              </button>
            </div>
          </div>
          <div className="mt-4">
            <h3 className="text-lg font-bold mb-2">Danh sách đối tượng</h3>
            <div className="table-container">
              <table className="table-fixed w-full border-collapse border">
                <thead>
                  <tr className="bg-gray-200">
                    <th className="border p-2 fixed-width-stt">STT</th>
                    <th className="border p-2 fixed-width-name">Họ tên</th>
                    <th className="border p-2 fixed-width-birth">Sinh ngày</th>
                    <th className="border p-2">Số CMND/CCCD</th>
                    <th className="border p-2 fixed-width-address">Nơi thường trú</th>
                    <th className="border p-2">Mối quan hệ</th>
                    <th className="border p-2">Hình thức xử lý</th>
                    <th className="border p-2">Ngày hết hạn tạm giữ</th>
                    <th className="border p-2">Ngày hết hạn tạm giam</th>
                    <th className="border p-2 fixed-width-action">Hành động</th>
                  </tr>
                </thead>
                <tbody>
                  {tempObjects.map((obj, index) => (
                    <tr key={index}>
                      <td className="border p-2 fixed-width-stt wrap-text">{index + 1}</td>
                      <td className="border p-2 fixed-width-name wrap-text" title={obj.name}>{obj.name}</td>
                      <td className="border p-2 fixed-width-birth wrap-text">{formatDateToVietnamese(obj.birthDate)}</td>
                      <td className="border p-2 wrap-text" title={obj.idNumber}>{obj.idNumber}</td>
                      <td className="border p-2 fixed-width-address wrap-text" title={obj.permanentAddress}>{obj.permanentAddress}</td>
                      <td className="border p-2 wrap-text" title={obj.relationship}>{obj.relationship}</td>
                      <td className="border p-2 wrap-text" title={obj.handlingMethod}>{obj.handlingMethod}</td>
                      <td className={`border p-2 wrap-text ${showRedCustody(obj) ? 'text-red-500' : 'text-green-500'}`}>{formatDateToVietnamese(obj.custodyExpirationDate)}</td>
                      <td className={`border p-2 wrap-text ${showRedDetention(obj, caseData.status) ? 'text-red-500' : getDetentionColor(obj, caseData.status)}`}>{formatDateToVietnamese(obj.detentionExpirationDate)}</td>
                      <td className="border p-2 fixed-width-action">
                        <button
                          className="bg-yellow-500 text-white px-2 py-1 rounded mr-2 active:scale-95 active:opacity-75 transition-transform action-button"
                          onClick={() => handleEditObject(index)}
                          disabled={!isEditing}
                        >
                          Chỉnh sửa
                        </button>
                        <button
                          className="bg-red-500 hover:bg-red-600 text-white px-2 py-1 rounded active:scale-95 active:opacity-75 transition-transform duration-200 ease-in-out action-button"
                          onClick={() => handleDeleteConfirm(index)}
                          disabled={!isEditing}
                        >
                          Xóa
                        </button>
                      </td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
          </div>
          <div className="mt-4">
            {editingCaseId && !isEditing && (
              <button
                className="bg-yellow-500 text-white px-4 py-2 rounded mr-2 active:scale-95 active:opacity-75 transition-transform"
                onClick={() => setIsEditing(true)}
              >
                Sửa
              </button>
            )}
            <button
              className="bg-green-500 text-white px-4 py-2 rounded mr-2 active:scale-95 active:opacity-75 transition-transform"
              onClick={handleSubmitCase}
              disabled={!isEditing}
            >
              Lưu
            </button>
            <button
              className="bg-gray-500 text-white px-4 py-2 rounded mr-2 active:scale-95 active:opacity-75 transition-transform"
              onClick={() => {
                setShowForm(false);
                setViewMode('list');
              }}
            >
              Quay lại
            </button>
          </div>
        </div>
      );
    };
    function debounce(func, wait) {
      let timeout;
      return function executedFunction(...args) {
        const later = () => {
          clearTimeout(timeout);
          func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
      };
    }
    const LoginForm = ({ setLoggedIn, setErrorMessage, setUsername, setPassword, username, password }) => {
      const [shake, setShake] = useState(false);
      const handleLogin = async (e) => {
        e.preventDefault();
        const hashedPassword = await hashPassword(password);
        const user = await getUserFromDB(username);
        if (user && user.password === hashedPassword) {
          sessionStorage.setItem('loggedIn', 'true');
          sessionStorage.setItem('username', username);
          setLoggedIn(true);
        } else {
          setErrorMessage('Tên đăng nhập hoặc mật khẩu không đúng.');
          setShake(true);
          setTimeout(() => setShake(false), 500);
        }
      };
      return (
        <div className="login-background">
          <div className={`login-form ${shake ? 'error-shake' : ''}`}>
            <h2 className="text-xl font-bold mb-4">Đăng Nhập</h2>
            <form onSubmit={handleLogin}>
              <div className="mb-4">
                <label className="block mb-1 font-medium">Tên đăng nhập</label>
                <input
                  type="text"
                  value={username}
                  onChange={(e) => setUsername(e.target.value)}
                  className="border p-2 rounded w-full"
                  required
                />
              </div>
              <div className="mb-4">
                <label className="block mb-1 font-medium">Mật khẩu</label>
                <input
                  type="password"
                  value={password}
                  onChange={(e) => setPassword(e.target.value)}
                  className="border p-2 rounded w-full"
                  required
                />
              </div>
              <button
                type="submit"
                className="bg-blue-500 text-white px-4 py-2 rounded w-full active:scale-95 active:opacity-75 transition-transform"
              >
                Đăng Nhập
              </button>
            </form>
          </div>
        </div>
      );
    };
    const ChangeCredentialsForm = ({ setShowChangeForm, setErrorMessage }) => {
      const [newUsername, setNewUsername] = useState('');
      const [newPassword, setNewPassword] = useState('');
      const [confirmPassword, setConfirmPassword] = useState('');
      const handleChange = async (e) => {
        e.preventDefault();
        if (newPassword !== confirmPassword) {
          setErrorMessage('Mật khẩu xác nhận không khớp.');
          return;
        }
        const hashedNewPassword = await hashPassword(newPassword);
        const user = { username: newUsername || sessionStorage.getItem('username'), password: hashedNewPassword };
        await saveUserToDB(user);
        setErrorMessage(null);
        setShowChangeForm(false);
        sessionStorage.clear();
        window.location.reload();
      };
      return (
        <div className="fixed inset-0 flex items-center justify-center bg-black bg-opacity-50">
          <div className="bg-white p-4 rounded shadow w-1/3">
            <h2 className="text-xl font-bold mb-4">Thay Đổi Mật Khẩu và Tên Đăng Nhập</h2>
            <form onSubmit={handleChange}>
              <div className="mb-4">
                <label className="block mb-1 font-medium">Tên đăng nhập mới (tùy chọn)</label>
                <input
                  type="text"
                  value={newUsername}
                  onChange={(e) => setNewUsername(e.target.value)}
                  className="border p-2 rounded w-full"
                />
              </div>
              <div className="mb-4">
                <label className="block mb-1 font-medium">Mật khẩu mới</label>
                <input
                  type="password"
                  value={newPassword}
                  onChange={(e) => setNewPassword(e.target.value)}
                  className="border p-2 rounded w-full"
                  required
                />
              </div>
              <div className="mb-4">
                <label className="block mb-1 font-medium">Xác nhận mật khẩu mới</label>
                <input
                  type="password"
                  value={confirmPassword}
                  onChange={(e) => setConfirmPassword(e.target.value)}
                  className="border p-2 rounded w-full"
                  required
                />
              </div>
              <div className="mt-4">
                <button
                  type="submit"
                  className="bg-green-500 text-white px-4 py-2 rounded mr-2 active:scale-95 active:opacity-75 transition-transform"
                >
                  Lưu
                </button>
                <button
                  className="bg-gray-500 text-white px-4 py-2 rounded active:scale-95 active:opacity-75 transition-transform"
                  onClick={() => setShowChangeForm(false)}
                >
                  Hủy
                </button>
              </div>
            </form>
          </div>
        </div>
      );
    };
    const App = () => {
      const [cases, setCases] = useState([]);
      const [caseTypesList, setCaseTypesList] = useState(defaultCaseTypes);
      const [assigneesList, setAssigneesList] = useState(defaultAssignees);
      const [receivingUnitsList, setReceivingUnitsList] = useState(defaultReceivingUnits);
      const [handlingMethodsList, setHandlingMethodsList] = useState(handlingMethods);
      const [showForm, setShowForm] = useState(false);
      const [showObjectForm, setShowObjectForm] = useState(false);
      const [editingCaseId, setEditingCaseId] = useState(null);
      const [isEditing, setIsEditing] = useState(false);
      const [tempObjects, setTempObjects] = useState([]);
      const [editingIndex, setEditingIndex] = useState(null);
      const [showConfirm, setShowConfirm] = useState(false);
      const [deleteIndex, setDeleteIndex] = useState(null);
      const [deleteCaseId, setDeleteCaseId] = useState(null);
      const [undoData, setUndoData] = useState(null);
      const [errorMessage, setErrorMessage] = useState(null);
      const [successMessage, setSuccessMessage] = useState(null);
      const [viewMode, setViewMode] = useState('list');
      const [reportFormData, setReportFormData] = useState({
        startDate: '2025-01-01',
        endDate: '2025-12-31',
        dataSource: 'both'
      });
      const [showExportFilter, setShowExportFilter] = useState(false);
      const [exportFilter, setExportFilter] = useState('both');
      const [filterCaseId, setFilterCaseId] = useState('');
      const [filterStartDate, setFilterStartDate] = useState('');
      const [filterEndDate, setFilterEndDate] = useState('');
      const [searchQuery, setSearchQuery] = useState('');
      const [statusFilter, setStatusFilter] = useState('all');
      const [currentPage, setCurrentPage] = useState(1);
      const itemsPerPage = 10;
      const [showEditLists, setShowEditLists] = useState(false);
      const [selectedList, setSelectedList] = useState('');
      const [caseData, setCaseData] = useState({
        id: '',
        type: [],
        dateReceived: '',
        description: '',
        seizedItems: '',
        assignee: '',
        directAssignee: '',
        investigationResult: '',
        crimeType: '',
        extensionCount: 0,
        investigationConclusionDate: '',
        prosecutionDate: '',
        prosecutionDecision: '',
        penaltyDate: '',
        penaltyDecision: '',
        transferDate: '',
        receivingUnit: '',
        status: 'đang thực hiện',
        reportDate: '',
        expirationDate: '',
        notes: '',
        objects: []
      });
      const [objectData, setObjectData] = useState({
        name: '',
        gender: '',
        alias: 'Không',
        birthDate: '',
        birthPlace: '',
        hometown: '',
        nationality: 'Việt Nam',
        ethnicity: 'Kinh',
        religion: 'Không',
        idNumber: '',
        issueDate: '',
        issuePlace: '',
        education: '',
        occupation: '',
        workplace: '',
        permanentAddress: '',
        phoneNumber: '',
        temporaryResidence: '',
        currentResidence: '',
        familyBackground: '',
        relationship: '',
        handlingMethod: '',
        behavior: [],
        penaltyForm: '',
        administrativeRecordNumber: '',
        administrativeDecisionNumber: '',
        reportDate: '',
        decisionDate: '',
        prosecutionDateObj: '',
        prosecutionDecisionObj: '',
        custodyDecisionDate: '',
        custodyDecisionNumber: '',
        custodyExtensionCount: '0',
        custodyExpirationDate: '',
        detentionDecisionDate: '',
        detentionDecisionNumber: '',
        detentionExtensionCount: '0',
        detentionExpirationDate: '',
        crimeType: '',
        photo: ''
      });
      const [loggedIn, setLoggedIn] = useState(!!sessionStorage.getItem('loggedIn'));
      const [username, setUsername] = useState('');
      const [password, setPassword] = useState('');
      const [showChangeForm, setShowChangeForm] = useState(false);
      const startDateRef = useRef(null);
      const endDateRef = useRef(null);
      const filterStartDateRef = useRef(null);
      const filterEndDateRef = useRef(null);
      let idleTimer;
      const resetIdleTimer = () => {
        clearTimeout(idleTimer);
        idleTimer = setTimeout(handleLogout, 30 * 60 * 1000); // 30 phút
      };
      const handleActivity = () => {
        resetIdleTimer();
      };
      const handleLogout = () => {
        sessionStorage.clear();
        setLoggedIn(false);
        setViewMode('list');
        setErrorMessage('Phiên đăng nhập đã hết hạn do không hoạt động.');
      };
      useEffect(() => {
        if (loggedIn) {
          document.addEventListener('mousemove', handleActivity);
          document.addEventListener('keydown', handleActivity);
          document.addEventListener('click', handleActivity);
          resetIdleTimer();
          return () => {
            document.removeEventListener('mousemove', handleActivity);
            document.removeEventListener('keydown', handleActivity);
            document.removeEventListener('click', handleActivity);
            clearTimeout(idleTimer);
          };
        }
      }, [loggedIn]);
      useEffect(() => {
        async function init() {
          await migrateFromLocalStorage();
          const loadedCases = await loadCasesFromDB();
          console.log('Loaded cases from DB:', loadedCases);
          setCases(validateCases(loadedCases));
          const [loadedCaseTypes, loadedAssignees, loadedReceivingUnits, loadedHandlingMethods] = await loadListsFromDB();
          setCaseTypesList(loadedCaseTypes || defaultCaseTypes);
          setAssigneesList(loadedAssignees || defaultAssignees);
          setReceivingUnitsList(loadedReceivingUnits || defaultReceivingUnits);
          setHandlingMethodsList(loadedHandlingMethods || handlingMethods);
          // Khởi tạo user mặc định nếu chưa có
          const defaultUser = await getUserFromDB('admin');
          if (!defaultUser) {
            const hashedPass = await hashPassword('password');
            await saveUserToDB({ username: 'admin', password: hashedPass });
          }
        }
        init();
      }, []);
      useEffect(() => {
        const debouncedSave = debounce(async () => {
          if (cases.length > 0) {
            try {
              await saveCasesToDB(cases);
              setSuccessMessage('Dữ liệu đã được lưu vào cơ sở dữ liệu.');
            } catch (error) {
              setErrorMessage('Lỗi khi lưu dữ liệu vào cơ sở dữ liệu: ' + error.message);
            }
          }
        }, 500);
        debouncedSave();
      }, [cases]);
      useEffect(() => {
        const today = new Date();
        const warnings = [];
        cases.forEach(c => {
          if (c.investigationResult === 'tin báo' && c.status !== 'hoàn thành' && c.expirationDate) {
            const exp = new Date(c.expirationDate);
            const days = Math.floor((exp - today) / (86400000));
            if (days > 0 && days <= 10) warnings.push(c.id + ' (tin báo)');
          }
          if (c.investigationResult === 'khởi tố vụ án' && c.status !== 'hoàn thành' && !c.investigationConclusionDate && c.expirationDate) {
            const exp = new Date(c.expirationDate);
            const days = Math.floor((exp - today) / (86400000));
            if (days > 0 && days <= 10) {
              warnings.push(c.id + ' (điều tra)');
              new Audio('data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEARKwAAIhYAQAADABAAAABAAgAZGF0YQAAAAA=').play();
            }
          }
          c.objects.forEach(obj => {
            if (obj.handlingMethod === 'khởi tố bị can' && c.status !== 'hoàn thành') {
              if (obj.custodyExpirationDate) {
                const exp = new Date(obj.custodyExpirationDate);
                const days = Math.floor((exp - today) / 86400000);
                if (days > 0 && days <= 2) warnings.push(c.id + ' - ' + obj.name + ' (tạm giữ)');
              }
              if (obj.detentionExpirationDate) {
                const exp = new Date(obj.detentionExpirationDate);
                const days = Math.floor((exp - today) / 86400000);
                if (days > 0 && days <= 10) {
                  warnings.push(c.id + ' - ' + obj.name + ' (tạm giam)');
                  new Audio('data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEARKwAAIhYAQAADABAAAABAAgAZGF0YQAAAAA=').play();
                }
              }
            }
          });
        });
        if (warnings.length > 0) {
          setErrorMessage(`Cảnh báo: Vụ việc ${warnings.join(', ')} sắp hết hạn (dưới 10 ngày). Yêu cầu kết luận điều tra hoặc gia hạn.`);
        }
      }, [cases]);
      useEffect(() => {
        if (undoData) {
          const timer = setTimeout(() => {
            setUndoData(null);
          }, 5000);
          return () => clearTimeout(timer);
        }
      }, [undoData]);
      useEffect(() => {
        if (successMessage) {
          const timer = setTimeout(() => {
            setSuccessMessage(null);
          }, 5000);
          return () => clearTimeout(timer);
        }
      }, [successMessage]);
      useEffect(() => {
        setCurrentPage(1);
      }, [viewMode, statusFilter, searchQuery]);
      useEffect(() => {
        console.log('showObjectForm:', showObjectForm);
      }, [showObjectForm]);
      useEffect(() => {
        if (viewMode === 'report') {
          flatpickr(startDateRef.current, {
            dateFormat: "d/m/Y",
            defaultDate: formatDateToVietnamese(reportFormData.startDate),
            onChange: ([date]) => {
              const year = date.getFullYear();
              const month = String(date.getMonth() + 1).padStart(2, '0');
              const day = String(date.getDate()).padStart(2, '0');
              const dateStr = `${day}/${month}/${year}`;
              setReportFormData({ ...reportFormData, startDate: parseDateFromVietnamese(dateStr) });
            }
          });
          flatpickr(endDateRef.current, {
            dateFormat: "d/m/Y",
            defaultDate: formatDateToVietnamese(reportFormData.endDate),
            onChange: ([date]) => {
              const year = date.getFullYear();
              const month = String(date.getMonth() + 1).padStart(2, '0');
              const day = String(date.getDate()).padStart(2, '0');
              const dateStr = `${day}/${month}/${year}`;
              setReportFormData({ ...reportFormData, endDate: parseDateFromVietnamese(dateStr) });
            }
          });
        }
      }, [viewMode, reportFormData.startDate, reportFormData.endDate]);
      useEffect(() => {
        if (showExportFilter) {
          flatpickr(filterStartDateRef.current, {
            dateFormat: "d/m/Y",
            defaultDate: formatDateToVietnamese(filterStartDate),
            onChange: ([date]) => {
              const year = date.getFullYear();
              const month = String(date.getMonth() + 1).padStart(2, '0');
              const day = String(date.getDate()).padStart(2, '0');
              const dateStr = `${day}/${month}/${year}`;
              setFilterStartDate(parseDateFromVietnamese(dateStr));
            }
          });
          flatpickr(filterEndDateRef.current, {
            dateFormat: "d/m/Y",
            defaultDate: formatDateToVietnamese(filterEndDate),
            onChange: ([date]) => {
              const year = date.getFullYear();
              const month = String(date.getMonth() + 1).padStart(2, '0');
              const day = String(date.getDate()).padStart(2, '0');
              const dateStr = `${day}/${month}/${year}`;
              setFilterEndDate(parseDateFromVietnamese(dateStr));
            }
          });
        }
      }, [showExportFilter, filterStartDate, filterEndDate]);
      const handleReportInputChange = (e) => {
        setReportFormData({ ...reportFormData, [e.target.name]: e.target.value });
      };
      const handlePrintReport = () => {
        window.print();
      };
      const handleExportFilterChange = (e) => {
        setExportFilter(e.target.value);
      };
      const handleSubmitExport = () => {
        console.log('Exporting with filter:', exportFilter, 'caseId:', filterCaseId, 'start:', filterStartDate, 'end:', filterEndDate);
        const error = exportToExcel(cases, exportFilter, filterCaseId, filterStartDate, filterEndDate);
        if (error) {
          setErrorMessage(error);
        } else {
          setSuccessMessage('Xuất dữ liệu thành công.');
        }
        setShowExportFilter(false);
      };
      const checkWarning = (obj) => {
        // Placeholder for additional warnings if needed
      };
      const handleSubmitObject = (e) => {
        console.log('Submitting object:', objectData);
        if (objectData.phoneNumber && !/^\+?\d{9,12}$/.test(objectData.phoneNumber)) {
          setErrorMessage('Số điện thoại không hợp lệ.');
          return;
        }
        if (objectData.birthDate) {
          try {
            const date = new Date(objectData.birthDate);
            if (isNaN(date.getTime()) || date > new Date()) {
              setErrorMessage('Ngày sinh không hợp lệ.');
              return;
            }
          } catch {
            setErrorMessage('Ngày sinh không hợp lệ.');
            return;
          }
        }
        checkWarning(objectData);
        if (editingIndex !== null) {
          const updatedObjects = [...tempObjects];
          updatedObjects[editingIndex] = objectData;
          setTempObjects(updatedObjects);
          setEditingIndex(null);
        } else {
          setTempObjects([...tempObjects, objectData]);
        }
        setObjectData({
          name: '',
          gender: '',
          alias: 'Không',
          birthDate: '',
          birthPlace: '',
          hometown: '',
          nationality: 'Việt Nam',
          ethnicity: 'Kinh',
          religion: 'Không',
          idNumber: '',
          issueDate: '',
          issuePlace: '',
          education: '',
          occupation: '',
          workplace: '',
          permanentAddress: '',
          phoneNumber: '',
          temporaryResidence: '',
          currentResidence: '',
          familyBackground: '',
          relationship: '',
          handlingMethod: '',
          behavior: [],
          penaltyForm: '',
          administrativeRecordNumber: '',
          administrativeDecisionNumber: '',
          reportDate: '',
          decisionDate: '',
          prosecutionDateObj: '',
          prosecutionDecisionObj: '',
          custodyDecisionDate: '',
          custodyDecisionNumber: '',
          custodyExtensionCount: '0',
          custodyExpirationDate: '',
          detentionDecisionDate: '',
          detentionDecisionNumber: '',
          detentionExtensionCount: '0',
          detentionExpirationDate: '',
          crimeType: '',
          photo: ''
        });
        setShowObjectForm(false);
        setSuccessMessage('Dữ liệu đã được lưu thành công.');
      };
      const handleDelete = () => {
        console.log('Deleting object at index:', deleteIndex, 'from tempObjects:', tempObjects);
        setUndoData({ type: 'object', data: tempObjects[deleteIndex], index: deleteIndex });
        const updatedObjects = tempObjects.filter((_, i) => i !== deleteIndex);
        setTempObjects([...updatedObjects]);
        setShowConfirm(false);
        setDeleteIndex(null);
        console.log('Updated tempObjects:', updatedObjects);
      };
      const handleDeleteCase = () => {
        console.log('Deleting case with id:', deleteCaseId);
        const deletedCase = cases.find(c => c.id === deleteCaseId);
        setUndoData({ type: 'case', data: deletedCase });
        setCases(cases.filter(c => c.id !== deleteCaseId));
        setShowConfirm(false);
        setDeleteCaseId(null);
      };
      const handleUndoDeleteObject = () => {
        if (undoData && undoData.type === 'object') {
          const updatedObjects = [...tempObjects];
          updatedObjects.splice(undoData.index, 0, undoData.data);
          setTempObjects([...updatedObjects]);
          setUndoData(null);
        }
      };
      const handleUndoDeleteCase = () => {
        if (undoData && undoData.type === 'case') {
          setCases([...cases, undoData.data]);
          setUndoData(null);
        }
      };
      const handleDeleteCaseConfirm = (id) => {
        console.log('Confirming delete case with id:', id);
        setDeleteCaseId(id);
        setTimeout(() => setShowConfirm(true), 0);
      };
      const handleEditCase = (c) => {
        console.log('Editing case:', c);
        setCaseData({ ...c, type: Array.isArray(c.type) ? c.type : [] });
        setTempObjects(c.objects || []);
        setShowForm(true);
        setEditingCaseId(c.id);
        setIsEditing(true);
        setViewMode('add');
      };
      const exportResume = () => {
        if (!objectData.name) {
          setErrorMessage('Vui lòng nhập ít nhất họ tên để xuất lý lịch.');
          return;
        }
        try {
          const doc = new Document({
            sections: [{
              properties: {
                page: {
                  margins: {
                    top: 1134,
                    right: 1134,
                    bottom: 1134,
                    left: 1417
                  }
                }
              },
              children: [
                new Paragraph({
                  children: [
                    new TextRun({ text: `Lý lịch ${objectData.name || 'Đối tượng'}`, font: { name: 'Times New Roman', fallback: 'Arial' }, size: 28, bold: true })],
                  alignment: AlignmentType.CENTER,
                  spacing: { after: 200 }
                }),
                new Paragraph({
                  children: [
                    new TextRun({ text: 'Họ tên: ', font: { name: 'Times New Roman', fallback: 'Arial' }, size: 28, bold: true }),
                    new TextRun({ text: objectData.name || '', font: { name: 'Times New Roman', fallback: 'Arial' }, size: 28 }),
                    new TextRun({ text: '\t', font: { name: 'Times New Roman', fallback: 'Arial' }, size: 28 }),
                    new TextRun({ text: 'Giới tính: ', font: { name: 'Times New Roman', fallback: 'Arial' }, size: 28, bold: true }),
                    new TextRun({ text: objectData.gender || '', font: { name: 'Times New Roman', fallback: 'Arial' }, size: 28 })
                  ],
                  tabStops: [{ type: 'left', position: 5000 }],
                  spacing: { after: 100 }
                }),
                new Paragraph({
                  children: [
                    new TextRun({ text: 'Tên gọi khác: ', font: { name: 'Times New Roman', fallback: 'Arial' }, size: 28, bold: true }),
                    new TextRun({ text: objectData.alias || '', font: { name: 'Times New Roman', fallback: 'Arial' }, size: 28 })
                  ],
                  spacing: { after: 100 }
                }),
                new Paragraph({
                  children: [
                    new TextRun({ text: 'Sinh ', font: { name: 'Times New Roman', fallback: 'Arial' }, size: 28, bold: true }),
                    new TextRun({ text: formatDateToFullVietnamese(objectData.birthDate) || '', font: { name: 'Times New Roman', fallback: 'Arial' }, size: 28 }),
                    new TextRun({ text: '\t', font: { name: 'Times New Roman', fallback: 'Arial' }, size: 28 }),
                    new TextRun({ text: 'tại: ', font: { name: 'Times New Roman', fallback: 'Arial' }, size: 28, bold: true }),
                    new TextRun({ text: objectData.birthPlace || '', font: { name: 'Times New Roman', fallback: 'Arial' }, size: 28 })
                  ],
                  tabStops: [{ type: 'left', position: 1000 }],
                  spacing: { after: 100 }
                }),
                new Paragraph({
                  children: [
                    new TextRun({ text: 'Quê quán: ', font: { name: 'Times New Roman', fallback: 'Arial' }, size: 28, bold: true }),
                    new TextRun({ text: objectData.hometown || '', font: { name: 'Times New Roman', fallback: 'Arial' }, size: 28 })
                  ],
                  spacing: { after: 100 }
                }),
                new Paragraph({
                  children: [
                    new TextRun({ text: 'Quốc tịch: ', font: { name: 'Times New Roman', fallback: 'Arial' }, size: 28, bold: true }),
                    new TextRun({ text: objectData.nationality || '', font: { name: 'Times New Roman', fallback: 'Arial' }, size: 28 }),
                    new TextRun({ text: '\t', font: { name: 'Times New Roman', fallback: 'Arial' }, size: 28 }),
                    new TextRun({ text: 'Dân tộc: ', font: { name: 'Times New Roman', fallback: 'Arial' }, size: 28, bold: true }),
                    new TextRun({ text: objectData.ethnicity || '', font: { name: 'Times New Roman', fallback: 'Arial' }, size: 28 }),
                    new TextRun({ text: '\t', font: { name: 'Times New Roman', fallback: 'Arial' }, size: 28 }),
                    new TextRun({ text: 'Tôn giáo: ', font: { name: 'Times New Roman', fallback: 'Arial' }, size: 28, bold: true }),
                    new TextRun({ text: objectData.religion || '', font: { name: 'Times New Roman', fallback: 'Arial' }, size: 28 })
                  ],
                  tabStops: [{ type: 'left', position: 1000 }],
                  spacing: { after: 100 }
                }),
                new Paragraph({
                  children: [
                    new TextRun({ text: 'Số CMND/Thẻ CCCD/Hộ chiếu: ', font: { name: 'Times New Roman', fallback: 'Arial' }, size: 28, bold: true }),
                    new TextRun({ text: objectData.idNumber || '', font: { name: 'Times New Roman', fallback: 'Arial' }, size: 28 })
                  ],
                  spacing: { after: 100 }
                }),
                new Paragraph({
                  children: [
                    new TextRun({ text: 'cấp ', font: { name: 'Times New Roman', fallback: 'Arial' }, size: 28, bold: true }),
                    new TextRun({ text: formatDateToFullVietnamese(objectData.issueDate) || '', font: { name: 'Times New Roman', fallback: 'Arial' }, size: 28 }),
                    new TextRun({ text: '\t', font: { name: 'Times New Roman', fallback: 'Arial' }, size: 28 }),
                    new TextRun({ text: 'Nơi cấp: ', font: { name: 'Times New Roman', fallback: 'Arial' }, size: 28, bold: true }),
                    new TextRun({ text: objectData.issuePlace || '', font: { name: 'Times New Roman', fallback: 'Arial' }, size: 28 })
                  ],
                  tabStops: [{ type: 'left', position: 1000 }],
                  spacing: { after: 100 }
                }),
                new Paragraph({
                  children: [
                    new TextRun({ text: 'Trình độ học vấn: ', font: { name: 'Times New Roman', fallback: 'Arial' }, size: 28, bold: true }),
                    new TextRun({ text: objectData.education || '', font: { name: 'Times New Roman', fallback: 'Arial' }, size: 28 })
                  ],
                  spacing: { after: 100 }
                }),
                new Paragraph({
                  children: [
                    new TextRun({ text: 'Nghề nghiệp: ', font: { name: 'Times New Roman', fallback: 'Arial' }, size: 28, bold: true }),
                    new TextRun({ text: objectData.occupation || '', font: { name: 'Times New Roman', fallback: 'Arial' }, size: 28 })
                  ],
                  spacing: { after: 100 }
                }),
                new Paragraph({
                  children: [
                    new TextRun({ text: 'Nơi làm việc: ', font: { name: 'Times New Roman', fallback: 'Arial' }, size: 28, bold: true }),
                    new TextRun({ text: objectData.workplace || '', font: { name: 'Times New Roman', fallback: 'Arial' }, size: 28 })
                  ],
                  spacing: { after: 100 }
                }),
                new Paragraph({
                  children: [
                    new TextRun({ text: 'Nơi thường trú: ', font: { name: 'Times New Roman', fallback: 'Arial' }, size: 28, bold: true }),
                    new TextRun({ text: objectData.permanentAddress || '', font: { name: 'Times New Roman', fallback: 'Arial' }, size: 28 })
                  ],
                  spacing: { after: 100 }
                }),
                new Paragraph({
                  children: [
                    new TextRun({ text: 'Nơi tạm trú: ', font: { name: 'Times New Roman', fallback: 'Arial' }, size: 28, bold: true }),
                    new TextRun({ text: objectData.temporaryResidence || '', font: { name: 'Times New Roman', fallback: 'Arial' }, size: 28 })
                  ],
                  spacing: { after: 100 }
                }),
                new Paragraph({
                  children: [
                    new TextRun({ text: 'Nơi ở hiện tại: ', font: { name: 'Times New Roman', fallback: 'Arial' }, size: 28, bold: true }),
                    new TextRun({ text: objectData.currentResidence || '', font: { name: 'Times New Roman', fallback: 'Arial' }, size: 28 })
                  ],
                  spacing: { after: 100 }
                }),
                new Paragraph({
                  children: [
                    new TextRun({ text: 'Hoàn cảnh gia đình: ', font: { name: 'Times New Roman', fallback: 'Arial' }, size: 28, bold: true }),
                    new TextRun({ text: objectData.familyBackground || '', font: { name: 'Times New Roman', fallback: 'Arial' }, size: 28 })
                  ],
                  spacing: { after: 100 }
                }),
                new Paragraph({
                  children: [new TextRun({ text: `Mẫu lời khai ${objectData.name || 'Đối tượng'}`, font: { name: 'Times New Roman', fallback: 'Arial' }, size: 28, bold: true })],
                  alignment: AlignmentType.CENTER,
                  spacing: { after: 200 }
                }),
                new Paragraph({
                  children: [
                    new TextRun({ text: 'Họ tên: ', font: { name: 'Times New Roman', fallback: 'Arial' }, size: 28, bold: true }),
                    new TextRun({ text: objectData.name || '', font: { name: 'Times New Roman', fallback: 'Arial' }, size: 28 }),
                    new TextRun({ text: '\t', font: { name: 'Times New Roman', fallback: 'Arial' }, size: 28 }),
                    new TextRun({ text: 'Giới tính: ', font: { name: 'Times New Roman', fallback: 'Arial' }, size: 28, bold: true }),
                    new TextRun({ text: objectData.gender || '', font: { name: 'Times New Roman', fallback: 'Arial' }, size: 28 })
                  ],
                  tabStops: [{ type: 'left', position: 5000 }],
                  spacing: { after: 100 }
                }),
                new Paragraph({
                  children: [
                    new TextRun({ text: 'Tên gọi khác: ', font: { name: 'Times New Roman', fallback: 'Arial' }, size: 28, bold: true }),
                    new TextRun({ text: objectData.alias || '', font: { name: 'Times New Roman', fallback: 'Arial' }, size: 28 })
                  ],
                  spacing: { after: 100 }
                }),
                new Paragraph({
                  children: [
                    new TextRun({ text: 'Sinh ', font: { name: 'Times New Roman', fallback: 'Arial' }, size: 28, bold: true }),
                    new TextRun({ text: formatDateToFullVietnamese(objectData.birthDate) || '', font: { name: 'Times New Roman', fallback: 'Arial' }, size: 28 }),
                    new TextRun({ text: '\t', font: { name: 'Times New Roman', fallback: 'Arial' }, size: 28 }),
                    new TextRun({ text: 'tại: ', font: { name: 'Times New Roman', fallback: 'Arial' }, size: 28, bold: true }),
                    new TextRun({ text: objectData.birthPlace || '', font: { name: 'Times New Roman', fallback: 'Arial' }, size: 28 })
                  ],
                  tabStops: [{ type: 'left', position: 1000 }],
                  spacing: { after: 100 }
                }),
                new Paragraph({
                  children: [
                    new TextRun({ text: 'Quốc tịch: ', font: { name: 'Times New Roman', fallback: 'Arial' }, size: 28, bold: true }),
                    new TextRun({ text: objectData.nationality || '', font: { name: 'Times New Roman', fallback: 'Arial' }, size: 28 }),
                    new TextRun({ text: '\t', font: { name: 'Times New Roman', fallback: 'Arial' }, size: 28 }),
                    new TextRun({ text: 'Dân tộc: ', font: { name: 'Times New Roman', fallback: 'Arial' }, size: 28, bold: true }),
                    new TextRun({ text: objectData.ethnicity || '', font: { name: 'Times New Roman', fallback: 'Arial' }, size: 28 }),
                    new TextRun({ text: '\t', font: { name: 'Times New Roman', fallback: 'Arial' }, size: 28 }),
                    new TextRun({ text: 'Tôn giáo: ', font: { name: 'Times New Roman', fallback: 'Arial' }, size: 28, bold: true }),
                    new TextRun({ text: objectData.religion || '', font: { name: 'Times New Roman', fallback: 'Arial' }, size: 28 })
                  ],
                  tabStops: [{ type: 'left', position: 1000 }],
                  spacing: { after: 100 }
                }),
                new Paragraph({
                  children: [
                    new TextRun({ text: 'Nghề nghiệp: ', font: { name: 'Times New Roman', fallback: 'Arial' }, size: 28, bold: true }),
                    new TextRun({ text: objectData.occupation || '', font: { name: 'Times New Roman', fallback: 'Arial' }, size: 28 })
                  ],
                  spacing: { after: 100 }
                }),
                new Paragraph({
                  children: [
                    new TextRun({ text: 'Số điện thoại để liên hệ khi cần thiết phục vụ điều tra: ', font: { name: 'Times New Roman', fallback: 'Arial' }, size: 28, bold: true }),
                    new TextRun({ text: objectData.phoneNumber || '', font: { name: 'Times New Roman', fallback: 'Arial' }, size: 28 })
                  ],
                  spacing: { after: 100 }
                }),
                new Paragraph({
                  children: [
                    new TextRun({ text: 'Số CMND/Thẻ CCCD/Hộ chiếu: ', font: { name: 'Times New Roman', fallback: 'Arial' }, size: 28, bold: true }),
                    new TextRun({ text: objectData.idNumber || '', font: { name: 'Times New Roman', fallback: 'Arial' }, size: 28 })
                  ],
                  spacing: { after: 100 }
                }),
                new Paragraph({
                  children: [
                    new TextRun({ text: 'cấp ', font: { name: 'Times New Roman', fallback: 'Arial' }, size: 28, bold: true }),
                    new TextRun({ text: formatDateToFullVietnamese(objectData.issueDate) || '', font: { name: 'Times New Roman', fallback: 'Arial' }, size: 28 }),
                    new TextRun({ text: '\t', font: { name: 'Times New Roman', fallback: 'Arial' }, size: 28 }),
                    new TextRun({ text: 'Nơi cấp: ', font: { name: 'Times New Roman', fallback: 'Arial' }, size: 28, bold: true }),
                    new TextRun({ text: objectData.issuePlace || '', font: { name: 'Times New Roman', fallback: 'Arial' }, size: 28 })
                  ],
                  tabStops: [{ type: 'left', position: 1000 }],
                  spacing: { after: 100 }
                }),
                new Paragraph({
                  children: [
                    new TextRun({ text: 'Nơi thường trú: ', font: { name: 'Times New Roman', fallback: 'Arial' }, size: 28, bold: true }),
                    new TextRun({ text: objectData.permanentAddress || '', font: { name: 'Times New Roman', fallback: 'Arial' }, size: 28 })
                  ],
                  spacing: { after: 100 }
                }),
                new Paragraph({
                  children: [
                    new TextRun({ text: 'Nơi tạm trú: ', font: { name: 'Times New Roman', fallback: 'Arial' }, size: 28, bold: true }),
                    new TextRun({ text: objectData.temporaryResidence || '', font: { name: 'Times New Roman', fallback: 'Arial' }, size: 28 })
                  ],
                  spacing: { after: 100 }
                }),
                new Paragraph({
                  children: [
                    new TextRun({ text: 'Nơi ở hiện tại: ', font: { name: 'Times New Roman', fallback: 'Arial' }, size: 28, bold: true }),
                    new TextRun({ text: objectData.currentResidence || '', font: { name: 'Times New Roman', fallback: 'Arial' }, size: 28 })
                  ],
                  spacing: { after: 100 }
                }),
              ]
            }]
          });
          Packer.toBlob(doc).then((blob) => {
            saveAs(blob, `${objectData.name || 'Đối tượng'}_ly_lich.docx`);
          }).catch(error => {
            console.error('Lỗi khi xuất lý lịch:', error);
            setErrorMessage('Không thể xuất file Word. Vui lòng kiểm tra dữ liệu và thử lại.');
          });
        } catch (error) {
          console.error('Lỗi khi xuất lý lịch:', error);
          setErrorMessage('Không thể xuất file Word. Vui lòng kiểm tra dữ liệu và thử lại.');
        }
      };
      const generateReport = () => {
        let filteredCases = cases.filter(c => c.dateReceived >= reportFormData.startDate && c.dateReceived <= reportFormData.endDate);
        const dataSource = reportFormData.dataSource;
        if (dataSource === 'ongoing') {
          filteredCases = filteredCases.filter(c => c.status !== 'hoàn thành');
        } else if (dataSource === 'completed') {
          filteredCases = filteredCases.filter(c => c.status === 'hoàn thành');
        }
        try {
          const doc = new Document({
            sections: [{
              properties: {
                page: {
                  size: { orientation: 'LANDSCAPE' },
                  margins: { top: 1134, right: 1134, bottom: 1134, left: 1417 }
                }
              },
              children: [
                new Paragraph({
                  children: [
                    new TextRun({
                      text: 'Tổ Phòng chống tội phạm',
                      font: { name: 'Times New Roman', fallback: 'Arial' },
                      size: 28,
                      bold: true
                    })
                  ],
                  alignment: AlignmentType.CENTER,
                  spacing: { after: 200 }
                }),
                new Paragraph({
                  children: [
                    new TextRun({
                      text: 'Báo cáo số vụ việc đang giải quyết/đã hoàn thành',
                      font: { name: 'Times New Roman', fallback: 'Arial' },
                      size: 28,
                      bold: true
                    })
                  ],
                  alignment: AlignmentType.CENTER,
                  spacing: { after: 200 }
                }),
                new Paragraph({
                  children: [
                    new TextRun({
                      text: `Từ ngày ${formatDateToVietnamese(reportFormData.startDate)} đến ngày ${formatDateToVietnamese(reportFormData.endDate)}`,
                      font: { name: 'Times New Roman', fallback: 'Arial' },
                      size: 28,
                      italics: true
                    })
                  ],
                  alignment: AlignmentType.CENTER,
                  spacing: { after: 400 }
                }),
                new Table({
                  width: { size: 100, type: WidthType.PERCENTAGE },
                  borders: {
                    top: { style: BorderStyle.SINGLE, size: 1 },
                    bottom: { style: BorderStyle.SINGLE, size: 1 },
                    left: { style: BorderStyle.SINGLE, size: 1 },
                    right: { style: BorderStyle.SINGLE, size: 1 },
                    insideHorizontal: { style: BorderStyle.SINGLE, size: 1 },
                    insideVertical: { style: BorderStyle.SINGLE, size: 1 }
                  },
                  rows: [
                    new TableRow({
                      children: [
                        new TableCell({
                          children: [new Paragraph({
                            children: [new TextRun({ text: 'STT', font: { name: 'Times New Roman', fallback: 'Arial' }, size: 28, bold: true })],
                            alignment: AlignmentType.CENTER
                          })],
                          width: { size: 5, type: WidthType.PERCENTAGE }
                        }),
                        new TableCell({
                          children: [new Paragraph({
                            children: [new TextRun({ text: 'Mã vụ việc', font: { name: 'Times New Roman', fallback: 'Arial' }, size: 28, bold: true })],
                            alignment: AlignmentType.CENTER
                          })],
                          width: { size: 10, type: WidthType.PERCENTAGE }
                        }),
                        new TableCell({
                          children: [new Paragraph({
                            children: [new TextRun({ text: 'Ngày tiếp nhận', font: { name: 'Times New Roman', fallback: 'Arial' }, size: 28, bold: true })],
                            alignment: AlignmentType.CENTER
                          })],
                          width: { size: 10, type: WidthType.PERCENTAGE }
                        }),
                        new TableCell({
                          children: [new Paragraph({
                            children: [new TextRun({ text: 'Nội dung vụ việc', font: { name: 'Times New Roman', fallback: 'Arial' }, size: 28, bold: true })],
                            alignment: AlignmentType.CENTER
                          })],
                          width: { size: 20, type: WidthType.PERCENTAGE }
                        }),
                        new TableCell({
                          children: [new Paragraph({
                            children: [new TextRun({ text: 'Người thụ lý chính', font: { name: 'Times New Roman', fallback: 'Arial' }, size: 28, bold: true })],
                            alignment: AlignmentType.CENTER
                          })],
                          width: { size: 10, type: WidthType.PERCENTAGE }
                        }),
                        new TableCell({
                          children: [new Paragraph({
                            children: [new TextRun({ text: 'Người trực tiếp làm', font: { name: 'Times New Roman', fallback: 'Arial' }, size: 28, bold: true })],
                            alignment: AlignmentType.CENTER
                          })],
                          width: { size: 10, type: WidthType.PERCENTAGE }
                        }),
                        new TableCell({
                          children: [new Paragraph({
                            children: [new TextRun({ text: 'Số đối tượng', font: { name: 'Times New Roman', fallback: 'Arial' }, size: 28, bold: true })],
                            alignment: AlignmentType.CENTER
                          })],
                          width: { size: 5, type: WidthType.PERCENTAGE }
                        }),
                        new TableCell({
                          children: [new Paragraph({
                            children: [new TextRun({ text: 'Tên đối tượng - Mối quan hệ với các đối tượng', font: { name: 'Times New Roman', fallback: 'Arial' }, size: 28, bold: true })],
                            alignment: AlignmentType.CENTER
                          })],
                          width: { size: 20, type: WidthType.PERCENTAGE }
                        }),
                        new TableCell({
                          children: [new Paragraph({
                            children: [new TextRun({ text: 'Trạng thái', font: { name: 'Times New Roman', fallback: 'Arial' }, size: 28, bold: true })],
                            alignment: AlignmentType.CENTER
                          })],
                          width: { size: 10, type: WidthType.PERCENTAGE }
                        })
                      ]
                    }),
                    ...filteredCases.map((c, index) => {
                      const objectsStr = c.objects && c.objects.length > 0
                        ? c.objects.map(obj => `${obj.name || ''} - ${obj.relationship || ''}`).join('; ')
                        : '';
                      return new TableRow({
                        children: [
                          new TableCell({
                            children: [new Paragraph({
                              children: [new TextRun({ text: (index + 1).toString(), font: { name: 'Times New Roman', fallback: 'Arial' }, size: 28 })],
                              alignment: AlignmentType.CENTER
                            })]
                          }),
                          new TableCell({
                            children: [new Paragraph({
                              children: [new TextRun({ text: c.id || '', font: { name: 'Times New Roman', fallback: 'Arial' }, size: 28 })],
                              alignment: AlignmentType.LEFT
                            })]
                          }),
                          new TableCell({
                            children: [new Paragraph({
                              children: [new TextRun({ text: formatDateToVietnamese(c.dateReceived) || '', font: { name: 'Times New Roman', fallback: 'Arial' }, size: 28 })],
                              alignment: AlignmentType.CENTER
                            })]
                          }),
                          new TableCell({
                            children: [new Paragraph({
                              children: [new TextRun({ text: c.description || '', font: { name: 'Times New Roman', fallback: 'Arial' }, size: 28 })],
                              alignment: AlignmentType.LEFT
                            })]
                          }),
                          new TableCell({
                            children: [new Paragraph({
                              children: [new TextRun({ text: c.assignee || '', font: { name: 'Times New Roman', fallback: 'Arial' }, size: 28 })],
                              alignment: AlignmentType.LEFT
                            })]
                          }),
                          new TableCell({
                            children: [new Paragraph({
                              children: [new TextRun({ text: c.directAssignee || '', font: { name: 'Times New Roman', fallback: 'Arial' }, size: 28 })],
                              alignment: AlignmentType.LEFT
                            })]
                          }),
                          new TableCell({
                            children: [new Paragraph({
                              children: [new TextRun({ text: (c.objects ? c.objects.length : 0).toString(), font: { name: 'Times New Roman', fallback: 'Arial' }, size: 28 })],
                              alignment: AlignmentType.CENTER
                            })]
                          }),
                          new TableCell({
                            children: [new Paragraph({
                              children: [new TextRun({ text: objectsStr, font: { name: 'Times New Roman', fallback: 'Arial' }, size: 28 })],
                              alignment: AlignmentType.LEFT
                            })]
                          }),
                          new TableCell({
                            children: [new Paragraph({
                              children: [new TextRun({ text: c.status || '', font: { name: 'Times New Roman', fallback: 'Arial' }, size: 28 })],
                              alignment: AlignmentType.CENTER
                            })]
                          })
                        ]
                      });
                    })
                  ]
                })
              ]
            }]
          });
          Packer.toBlob(doc).then((blob) => {
            saveAs(blob, 'BaoCaoVuViec.docx');
          }).catch(error => {
            console.error('Lỗi khi xuất báo cáo:', error);
            setErrorMessage('Không thể xuất file Word. Vui lòng kiểm tra dữ liệu và thử lại.');
          });
        } catch (error) {
          console.error('Lỗi khi tạo báo cáo:', error);
          setErrorMessage('Không thể tạo báo cáo. Vui lòng kiểm tra dữ liệu và thử lại.');
        }
      };
      const filteredCases = useMemo(() => {
        console.log('Filtering cases:', cases, 'searchQuery:', searchQuery, 'statusFilter:', statusFilter);
        const lowerSearchQuery = searchQuery.toLowerCase();
        return cases.filter(c => {
          const matchesSearch = searchQuery
            ? (c.id?.toLowerCase().includes(lowerSearchQuery) || (Array.isArray(c.type) ? c.type.some(type => type.toLowerCase().includes(lowerSearchQuery)) : c.type?.toLowerCase().includes(lowerSearchQuery)))
            : true;
          const matchesStatus = statusFilter === 'all' || c.status === statusFilter;
          return matchesSearch && matchesStatus;
        });
      }, [cases, searchQuery, statusFilter]);
      const totalPages = Math.ceil(filteredCases.length / itemsPerPage);
      const paginatedCases = filteredCases.slice((currentPage - 1) * itemsPerPage, currentPage * itemsPerPage);
      const daysLeft = (expDate) => {
        if (!expDate) return Infinity;
        const exp = new Date(expDate);
        const now = new Date();
        return Math.floor((exp - now) / (1000 * 60 * 60 * 24));
      };
      const getMinExpiration = (objects, field) => {
        let minDate = null;
        objects.forEach(obj => {
          if (obj[field]) {
            const d = new Date(obj[field]);
            if (!minDate || d < minDate) minDate = d;
          }
        });
        return minDate ? minDate.toISOString().split('T')[0] : '';
      };
      const isCustodyRedInCase = (c) => {
        return c.objects.some(obj => {
          const dl = daysLeft(obj.custodyExpirationDate);
          return dl <= 2 && (!obj.detentionDecisionDate || !obj.detentionDecisionNumber);
        });
      };
      const isDetentionRedInCase = (c) => {
        return c.objects.some(obj => {
          const dl = daysLeft(obj.detentionExpirationDate);
          if (dl > 10) return false;
          const maxExt = maxDetentionExtensions[obj.crimeType] || 0;
          const extCount = parseInt(obj.detentionExtensionCount) || 0;
          const isAtMax = extCount >= maxExt;
          const isCompleted = c.status === 'hoàn thành';
          return !isAtMax || (isAtMax && !isCompleted);
        });
      };
      const getDetentionColorInCase = (c) => {
        return c.objects.every(obj => daysLeft(obj.detentionExpirationDate) > 10) ? 'text-green-500' : '';
      };
      const isInvestigationRedInCase = (c) => {
        const dl = daysLeft(c.expirationDate);
        if (dl > 10) return false;
        const maxExt = maxInvestigationExtensions[c.crimeType] || 0;
        const extCount = c.extensionCount || 0;
        const isAtMax = extCount >= maxExt;
        const isCompleted = c.status === 'hoàn thành';
        return !isAtMax || (isAtMax && !isCompleted);
      };
      const getInvestigationColorInCase = (c) => {
        return daysLeft(c.expirationDate) > 10 ? 'text-green-500' : '';
      };
      if (!loggedIn) {
        return <LoginForm setLoggedIn={setLoggedIn} setErrorMessage={setErrorMessage} setUsername={setUsername} setPassword={setPassword} username={username} password={password} />;
      }
      return (
        <div className="flex h-screen">
          <div className="w-1/5 bg-gray-100 p-4">
            <h2 className="text-xl font-bold mb-4">Phần mềm quản lý vụ việc</h2>
            <button
              className="bg-blue-500 text-white px-4 py-2 rounded w-full mb-2 active:scale-95 active:opacity-75 transition-transform"
              onClick={() => {
                setShowForm(false);
                setShowObjectForm(false);
                setViewMode('list');
              }}
            >
              Vụ việc mới
            </button>
            <button
              className="bg-blue-500 text-white px-4 py-2 rounded w-full mb-2 active:scale-95 active:opacity-75 transition-transform"
              onClick={() => {
                setShowForm(false);
                setShowObjectForm(false);
                setViewMode('completed');
              }}
            >
              Vụ án đã kết thúc
            </button>
            <button
              className="bg-blue-500 text-white px-4 py-2 rounded w-full mb-2 active:scale-95 active:opacity-75 transition-transform"
              onClick={() => {
                setShowForm(false);
                setShowObjectForm(false);
                setViewMode('report');
              }}
            >
              Báo cáo
            </button>
            <button
              className="bg-green-500 text-white px-4 py-2 rounded w-full mb-2 active:scale-95 active:opacity-75 transition-transform"
              onClick={() => {
                const error = backupCases(cases);
                if (error) setErrorMessage(error);
              }}
            >
              Sao lưu dữ liệu
            </button>
            <label className="bg-yellow-500 text-white px-4 py-2 rounded w-full mb-2 inline-block cursor-pointer text-center active:scale-95 active:opacity-75 transition-transform">
              Khôi phục dữ liệu
              <input
                type="file"
                accept=".json,.xlsx"
                onChange={(e) => restoreCases(e, setErrorMessage)}
                className="hidden"
              />
            </label>
            <button
              className="bg-purple-500 text-white px-4 py-2 rounded w-full mb-2 active:scale-95 active:opacity-75 transition-transform"
              onClick={() => setShowExportFilter(true)}
            >
              Xuất dữ liệu
            </button>
            <button
              className="bg-pink-500 text-white px-4 py-2 rounded w-full mb-2 active:scale-95 active:opacity-75 transition-transform"
              onClick={() => setShowChangeForm(true)}
            >
              Thay đổi mật khẩu và user
            </button>
            <button
              className="bg-indigo-500 text-white px-4 py-2 rounded w-full mb-2 active:scale-95 active:opacity-75 transition-transform"
              onClick={() => setShowEditLists(true)}
            >
              Chỉnh sửa danh sách
            </button>
            <button
              className="bg-red-500 text-white px-4 py-2 rounded w-full active:scale-95 active:opacity-75 transition-transform"
              onClick={handleLogout}
            >
              Đăng xuất
            </button>
          </div>
          <div className="w-4/5 p-4">
            {showEditLists && (
              <EditListsModal
                showEditLists={showEditLists}
                setShowEditLists={setShowEditLists}
                selectedList={selectedList}
                setSelectedList={setSelectedList}
                caseTypesList={caseTypesList}
                setCaseTypesList={setCaseTypesList}
                assigneesList={assigneesList}
                setAssigneesList={setAssigneesList}
                receivingUnitsList={receivingUnitsList}
                setReceivingUnitsList={setReceivingUnitsList}
                handlingMethodsList={handlingMethodsList}
                setHandlingMethodsList={setHandlingMethodsList}
                setErrorMessage={setErrorMessage}
              />
            )}
            {showChangeForm && <ChangeCredentialsForm setShowChangeForm={setShowChangeForm} setErrorMessage={setErrorMessage} />}
            {showObjectForm ? (
              <ObjectForm
                objectData={objectData}
                setObjectData={setObjectData}
                tempObjects={tempObjects}
                setTempObjects={setTempObjects}
                editingIndex={editingIndex}
                setEditingIndex={setEditingIndex}
                setShowObjectForm={setShowObjectForm}
                handleSubmitObject={handleSubmitObject}
                exportResume={exportResume}
                caseData={caseData}
                setErrorMessage={setErrorMessage}
                caseTypesList={caseTypesList}
                handlingMethodsList={handlingMethodsList}
              />
            ) : showForm ? (
              <CaseForm
                caseData={caseData}
                setCaseData={setCaseData}
                tempObjects={tempObjects}
                setTempObjects={setTempObjects}
                editingCaseId={editingCaseId}
                isEditing={isEditing}
                setIsEditing={setIsEditing}
                setShowForm={setShowForm}
                setViewMode={setViewMode}
                cases={cases}
                setCases={setCases}
                setShowObjectForm={setShowObjectForm}
                setObjectData={setObjectData}
                setEditingIndex={setEditingIndex}
                setDeleteIndex={setDeleteIndex}
                setShowConfirm={setShowConfirm}
                setUndoData={setUndoData}
                setErrorMessage={setErrorMessage}
                setSuccessMessage={setSuccessMessage}
                assigneesList={assigneesList}
                receivingUnitsList={receivingUnitsList}
                caseTypesList={caseTypesList}
                handlingMethodsList={handlingMethodsList}
              />
            ) : viewMode === 'report' ? (
              <div className="bg-white p-4 shadow rounded">
                <h2 className="text-xl font-bold mb-4">Tạo Báo Cáo</h2>
                <div className="grid grid-cols-2 gap-4">
                  <div>
                    <label className="block mb-1 font-medium">Từ ngày</label>
                    <input
                      type="text"
                      ref={startDateRef}
                      name="startDate"
                      placeholder="dd/mm/yyyy"
                      className="border p-2 rounded w-full"
                    />
                  </div>
                  <div>
                    <label className="block mb-1 font-medium">Đến ngày</label>
                    <input
                      type="text"
                      ref={endDateRef}
                      name="endDate"
                      placeholder="dd/mm/yyyy"
                      className="border p-2 rounded w-full"
                    />
                  </div>
                  <div>
                    <label className="block mb-1 font-medium">Nguồn dữ liệu</label>
                    <select
                      name="dataSource"
                      value={reportFormData.dataSource}
                      onChange={handleReportInputChange}
                      className="border p-2 rounded w-full"
                    >
                      <option value="ongoing">Vụ việc mới</option>
                      <option value="completed">Vụ án đã kết thúc</option>
                      <option value="both">Cả hai</option>
                    </select>
                  </div>
                </div>
                <div className="mt-4">
                  <button
                    className="bg-green-500 text-white px-4 py-2 rounded mr-2 active:scale-95 active:opacity-75 transition-transform"
                    onClick={generateReport}
                  >
                    Xuất báo cáo
                  </button>
                  <button
                    className="bg-blue-500 text-white px-4 py-2 rounded mr-2 active:scale-95 active:opacity-75 transition-transform"
                    onClick={handlePrintReport}
                  >
                    In báo cáo
                  </button>
                  <button
                    className="bg-gray-500 text-white px-4 py-2 rounded active:scale-95 active:opacity-75 transition-transform"
                    onClick={() => setViewMode('list')}
                  >
                    Quay lại
                  </button>
                </div>
              </div>
            ) : (
              <div>
                {viewMode === 'list' && (
                  <>
                    <div className="flex justify-between items-center mb-4">
                      <h2 className="text-xl font-bold">Danh Sách Vụ Việc</h2>
                      <button
                        className="bg-blue-500 text-white px-4 py-2 rounded active:scale-95 active:opacity-75 transition-transform"
                        onClick={() => {
                          console.log('Adding new case');
                          setShowForm(true);
                          setShowObjectForm(false);
                          setTempObjects([]);
                          setEditingCaseId(null);
                          setIsEditing(true);
                          setViewMode('add');
                          setCaseData({
                            id: '',
                            type: [],
                            dateReceived: '',
                            description: '',
                            seizedItems: '',
                            assignee: '',
                            directAssignee: '',
                            investigationResult: '',
                            crimeType: '',
                            extensionCount: 0,
                            investigationConclusionDate: '',
                            prosecutionDate: '',
                            prosecutionDecision: '',
                            penaltyDate: '',
                            penaltyDecision: '',
                            transferDate: '',
                            receivingUnit: '',
                            status: 'đang thực hiện',
                            reportDate: '',
                            expirationDate: '',
                            notes: '',
                            objects: []
                          });
                        }}
                      >
                        Thêm mới
                      </button>
                    </div>
                    <div className="flex gap-4 mb-4">
                      <input
                        type="text"
                        value={searchQuery}
                        onChange={(e) => setSearchQuery(e.target.value)}
                        placeholder="Tìm kiếm theo mã số vụ hoặc loại vụ việc"
                        className="border p-2 rounded w-full"
                      />
                      <select
                        value={statusFilter}
                        onChange={(e) => setStatusFilter(e.target.value)}
                        className="border p-2 rounded"
                      >
                        <option value="all">Tất cả</option>
                        <option value="đang thực hiện">Đang thực hiện</option>
                        <option value="hoàn thành">Hoàn thành</option>
                      </select>
                    </div>
                    <div className="table-container">
                      <table className="table-fixed w-full border-collapse border">
                        <thead>
                          <tr className="bg-gray-200">
                            <th className="border p-2 fixed-width-stt">STT</th>
                            <th className="border p-2 fixed-width-id">Mã Số Vụ</th>
                            <th className="border p-2 fixed-width-type">Loại Vụ Việc</th>
                            <th className="border p-2 fixed-width-date">Ngày Tiếp Nhận</th>
                            <th className="border p-2 fixed-width-description">Nội Dung Vụ Việc</th>
                            <th className="border p-2 fixed-width-object-count">Số Đối Tượng</th>
                            <th className="border p-2 fixed-width-status">Trạng Thái</th>
                            <th className="border p-2 fixed-width-date">Ngày Hết Hạn Điều Tra</th>
                            <th className="border p-2 fixed-width-date">Ngày Hết Hạn Tạm Giữ</th>
                            <th className="border p-2 fixed-width-date">Ngày Hết Hạn Tạm Giam</th>
                            <th className="border p-2 fixed-width-action">Hành Động</th>
                          </tr>
                        </thead>
                        <tbody>
                          {paginatedCases.filter(c => c.status !== 'hoàn thành').map((c, index) => {
                            const minCustodyExp = getMinExpiration(c.objects, 'custodyExpirationDate');
                            const minDetentionExp = getMinExpiration(c.objects, 'detentionExpirationDate');
                            return (
                              <tr key={c.id}>
                                <td className="border p-2 fixed-width-stt wrap-text">{(currentPage - 1) * itemsPerPage + index + 1}</td>
                                <td className="border p-2 fixed-width-id wrap-text" title={c.id}>{c.id}</td>
                                <td className="border p-2 fixed-width-type wrap-text" title={Array.isArray(c.type) ? c.type.join(', ') : c.type}>{Array.isArray(c.type) ? c.type.join(', ') : c.type}</td>
                                <td className="border p-2 fixed-width-date wrap-text">{formatDateToVietnamese(c.dateReceived)}</td>
                                <td className="border p-2 fixed-width-description wrap-text" title={c.description}>{c.description}</td>
                                <td className="border p-2 fixed-width-object-count wrap-text">{c.objects ? c.objects.length : 0}</td>
                                <td className="border p-2 fixed-width-status wrap-text">{c.status}</td>
                                <td className={`border p-2 fixed-width-date wrap-text ${isInvestigationRedInCase(c) ? 'text-red-500' : getInvestigationColorInCase(c)}`}>{formatDateToVietnamese(c.expirationDate)}</td>
                                <td className={`border p-2 fixed-width-date wrap-text ${isCustodyRedInCase(c) ? 'text-red-500' : 'text-green-500'}`}>{formatDateToVietnamese(minCustodyExp)}</td>
                                <td className={`border p-2 fixed-width-date wrap-text ${isDetentionRedInCase(c) ? 'text-red-500' : getDetentionColorInCase(c)}`}>{formatDateToVietnamese(minDetentionExp)}</td>
                                <td className="border p-2 fixed-width-action">
                                  <button
                                    className="bg-blue-500 text-white px-2 py-1 rounded mr-2 active:scale-95 active:opacity-75 transition-transform action-button"
                                    onClick={() => handleEditCase(c)}
                                  >
                                    Chỉnh Sửa
                                  </button>
                                  <button
                                    className="bg-red-500 hover:bg-red-600 text-white px-2 py-1 rounded active:scale-95 active:opacity-75 transition-transform duration-200 ease-in-out action-button"
                                    onClick={() => handleDeleteCaseConfirm(c.id)}
                                  >
                                    Xóa
                                  </button>
                                </td>
                              </tr>
                            );
                          })}
                        </tbody>
                      </table>
                    </div>
                    <div className="flex justify-between mt-4">
                      <button
                        className="bg-gray-500 text-white px-4 py-2 rounded disabled:opacity-50 active:scale-95 active:opacity-75 transition-transform"
                        disabled={currentPage === 1}
                        onClick={() => setCurrentPage(currentPage - 1)}
                      >
                        Trước
                      </button>
                      <span>Trang {currentPage} / {totalPages}</span>
                      <button
                        className="bg-gray-500 text-white px-4 py-2 rounded disabled:opacity-50 active:scale-95 active:opacity-75 transition-transform"
                        disabled={currentPage === totalPages}
                        onClick={() => setCurrentPage(currentPage + 1)}
                      >
                        Sau
                      </button>
                    </div>
                  </>
                )}
                {viewMode === 'completed' && (
                  <>
                    <div className="flex justify-between items-center mb-4">
                      <h2 className="text-xl font-bold">Danh Sách Vụ Án Đã Kết Thúc</h2>
                    </div>
                    <div className="flex gap-4 mb-4">
                      <input
                        type="text"
                        value={searchQuery}
                        onChange={(e) => setSearchQuery(e.target.value)}
                        placeholder="Tìm kiếm theo mã số vụ hoặc loại vụ việc"
                        className="border p-2 rounded w-full"
                      />
                      <select
                        value={statusFilter}
                        onChange={(e) => setStatusFilter(e.target.value)}
                        className="border p-2 rounded"
                      >
                        <option value="all">Tất cả</option>
                        <option value="hoàn thành">Hoàn thành</option>
                      </select>
                    </div>
                    <div className="table-container">
                      <table className="table-fixed w-full border-collapse border">
                        <thead>
                          <tr className="bg-gray-200">
                            <th className="border p-2 fixed-width-stt">STT</th>
                            <th className="border p-2 fixed-width-id">Mã Số Vụ</th>
                            <th className="border p-2 fixed-width-type">Loại Vụ Việc</th>
                            <th className="border p-2 fixed-width-date">Ngày Tiếp Nhận</th>
                            <th className="border p-2 fixed-width-description">Nội Dung Vụ Việc</th>
                            <th className="border p-2 fixed-width-object-count">Số Đối Tượng</th>
                            <th className="border p-2 fixed-width-investigation-result">Kết quả điều tra</th>
                            <th className="border p-2 fixed-width-status">Trạng Thái</th>
                            <th className="border p-2 fixed-width-action">Hành Động</th>
                          </tr>
                        </thead>
                        <tbody>
                          {paginatedCases.filter(c => c.status === 'hoàn thành').map((c, index) => (
                            <tr key={c.id}>
                              <td className="border p-2 fixed-width-stt wrap-text">{(currentPage - 1) * itemsPerPage + index + 1}</td>
                              <td className="border p-2 fixed-width-id wrap-text" title={c.id}>{c.id}</td>
                              <td className="border p-2 fixed-width-type wrap-text" title={Array.isArray(c.type) ? c.type.join(', ') : c.type}>{Array.isArray(c.type) ? c.type.join(', ') : c.type}</td>
                              <td className="border p-2 fixed-width-date wrap-text">{formatDateToVietnamese(c.dateReceived)}</td>
                              <td className="border p-2 fixed-width-description wrap-text" title={c.description}>{c.description}</td>
                              <td className="border p-2 fixed-width-object-count wrap-text">{c.objects ? c.objects.length : 0}</td>
                              <td className="border p-2 fixed-width-investigation-result wrap-text" title={c.investigationResult}>{c.investigationResult}</td>
                              <td className="border p-2 fixed-width-status wrap-text">{c.status}</td>
                              <td className="border p-2 fixed-width-action">
                                <button
                                  className="bg-blue-500 text-white px-2 py-1 rounded mr-2 active:scale-95 active:opacity-75 transition-transform action-button"
                                  onClick={() => handleEditCase(c)}
                                >
                                  Chỉnh Sửa
                                </button>
                                <button
                                  className="bg-red-500 hover:bg-red-600 text-white px-2 py-1 rounded active:scale-95 active:opacity-75 transition-transform duration-200 ease-in-out action-button"
                                  onClick={() => handleDeleteCaseConfirm(c.id)}
                                >
                                  Xóa
                                </button>
                              </td>
                            </tr>
                          ))}
                        </tbody>
                      </table>
                    </div>
                    <div className="flex justify-between mt-4">
                      <button
                        className="bg-gray-500 text-white px-4 py-2 rounded disabled:opacity-50 active:scale-95 active:opacity-75 transition-transform"
                        disabled={currentPage === 1}
                        onClick={() => setCurrentPage(currentPage - 1)}
                      >
                        Trước
                      </button>
                      <span>Trang {currentPage} / {totalPages}</span>
                      <button
                        className="bg-gray-500 text-white px-4 py-2 rounded disabled:opacity-50 active:scale-95 active:opacity-75 transition-transform"
                        disabled={currentPage === totalPages}
                        onClick={() => setCurrentPage(currentPage + 1)}
                      >
                        Sau
                      </button>
                    </div>
                  </>
                )}
                {undoData && (
                  <div className="undo-toast">
                    <span>{undoData.type === 'case' ? 'Đã xóa vụ việc' : 'Đã xóa đối tượng'}</span>
                    <button
                      className="bg-blue-500 text-white px-2 py-1 rounded active:scale-95 active:opacity-75 transition-transform"
                      onClick={undoData.type === 'case' ? handleUndoDeleteCase : handleUndoDeleteObject}
                    >
                      Hoàn tác
                    </button>
                    <button className="close" onClick={() => setUndoData(null)}>×</button>
                  </div>
                )}
                {errorMessage && (
                  <div className="error-toast">
                    <span>{errorMessage}</span>
                    <button className="close" onClick={() => setErrorMessage(null)}>×</button>
                  </div>
                )}
                {successMessage && (
                  <div className="success-toast">
                    <span>{successMessage}</span>
                    <button className="close" onClick={() => setSuccessMessage(null)}>×</button>
                  </div>
                )}
                {showConfirm && (
                  <div className="fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 fixed-inset-0">
                    <div className="bg-white p-4 rounded shadow">
                      <p>Bạn có muốn xóa {deleteCaseId ? 'vụ việc' : 'đối tượng'}?</p>
                      <div className="mt-4">
                        <button
                          className="bg-red-500 text-white px-4 py-2 rounded mr-2 active:scale-95 active:opacity-75 transition-transform"
                          onClick={deleteCaseId ? handleDeleteCase : handleDelete}
                        >
                          Xóa
                        </button>
                        <button
                          className="bg-gray-500 text-white px-4 py-2 rounded active:scale-95 active:opacity-75 transition-transform"
                          onClick={() => {
                            setShowConfirm(false);
                            setDeleteCaseId(null);
                            setDeleteIndex(null);
                          }}
                        >
                          Không
                        </button>
                      </div>
                    </div>
                  </div>
                )}
                {showExportFilter && (
                  <div className="fixed inset-0 flex items-center justify-center bg-black bg-opacity-50">
                    <div className="bg-white p-4 rounded shadow w-1/3">
                      <h2 className="text-xl font-bold mb-4">Chọn Lọc Dữ Liệu Để Xuất</h2>
                      <div className="mb-4">
                        <label className="block mb-1 font-medium">Loại dữ liệu</label>
                        <select
                          value={exportFilter}
                          onChange={handleExportFilterChange}
                          className="border p-2 rounded w-full"
                        >
                          <option value="both">Tất cả</option>
                          <option value="ongoing">Vụ việc mới (Đang thực hiện)</option>
                          <option value="completed">Vụ án đã kết thúc (Hoàn thành)</option>
                        </select>
                      </div>
                      <div className="mb-4">
                        <label className="block mb-1 font-medium">Mã vụ việc</label>
                        <input
                          type="text"
                          value={filterCaseId}
                          onChange={(e) => setFilterCaseId(e.target.value)}
                          className="border p-2 rounded w-full"
                          placeholder="Nhập mã vụ việc để lọc"
                        />
                      </div>
                      <div className="grid grid-cols-2 gap-4 mb-4">
                        <div>
                          <label className="block mb-1 font-medium">Từ ngày</label>
                          <input
                            type="text"
                            ref={filterStartDateRef}
                            name="filterStartDate"
                            placeholder="dd/mm/yyyy"
                            className="border p-2 rounded w-full"
                          />
                        </div>
                        <div>
                          <label className="block mb-1 font-medium">Đến ngày</label>
                          <input
                            type="text"
                            ref={filterEndDateRef}
                            name="filterEndDate"
                            placeholder="dd/mm/yyyy"
                            className="border p-2 rounded w-full"
                          />
                        </div>
                      </div>
                      <div className="mt-4">
                        <button
                          className="bg-green-500 text-white px-4 py-2 rounded mr-2 active:scale-95 active:opacity-75 transition-transform"
                          onClick={handleSubmitExport}
                        >
                          Xuất
                        </button>
                        <button
                          className="bg-gray-500 text-white px-4 py-2 rounded active:scale-95 active:opacity-75 transition-transform"
                          onClick={() => setShowExportFilter(false)}
                        >
                          Hủy
                        </button>
                      </div>
                    </div>
                  </div>
                )}
              </div>
            )}
          </div>
        </div>
      );
    };
    try {
      ReactDOM.render(<App />, document.getElementById('root'));
      console.log('ReactDOM.render executed successfully');
    } catch (error) {
      console.error('Error rendering React app:', error);
      document.getElementById('root').innerHTML = '<h1>Lỗi: Không thể hiển thị ứng dụng. Vui lòng kiểm tra Console.</h1>';
    }
  </script>
</body>
</html>